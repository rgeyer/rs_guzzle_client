HTTP/1.1 200 OK
Server: nginx/1.0.14
Date: Fri, 21 Sep 2012 16:40:11 GMT
Content-Type: application/vnd.rightscale.publication+xml;type=collection;charset=utf-8
Connection: keep-alive
Status: 200 OK
X-Runtime: 13601
Content-Length: 237401
X-Request-Uuid: 5f2a6093989143db99779172abc441ba
Set-Cookie: _session_id=52b92ef9e13daf1929dae4b5221dfbde; path=/; Secure; HttpOnly
Cache-Control: private, max-age=0, must-revalidate

<?xml version="1.0" encoding="UTF-8"?>
<publications>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2010/10/18 20:15:08 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>RightScript</content_type>
    <commit_message>
      <text>Ready to publish with OpenLDAP Directory Server v1 Server Template.</text>
      <time>2010/10/18 19:31:21 +0000</time>
      <user>rgeyer@mentorcorp.com</user>
    </commit_message>
    <description>Creates a new LDAP database with the defined $LDAP_DB_BASE_DN.  If the base dn is empty, a database which will contain all naming contexts (except cn=config) will be created.

Requires the tools installed by the "LDAP Tools Install" RightScript.</description>
    <name>LDAP Create Database</name>
    <created_at>2010/10/18 20:15:03 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>2</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2010/10/18 20:15:08 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>RightScript</content_type>
    <commit_message>
      <text>Ready to publish with OpenLDAP Directory Server v1 Server Template.</text>
      <time>2010/10/18 19:31:09 +0000</time>
      <user>rgeyer@mentorcorp.com</user>
    </commit_message>
    <description>Initializes this server as the LDAP provider by adding the syncprov module and overlay to all currently configured databases.

If this server is already setup as the provider, the syncprov overlay will be deleted and recreated for all configured databases.

If the server is a consumer, this script will fail.

Requires the tools installed by the "LDAP Tools Install" RightScript.</description>
    <name>LDAP Initialize Provider</name>
    <created_at>2010/10/18 20:15:04 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>1</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2010/10/18 20:15:08 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>RightScript</content_type>
    <commit_message>
      <text>Ready to publish with OpenLDAP Directory Server v1 Server Template.</text>
      <time>2010/10/18 19:31:01 +0000</time>
      <user>rgeyer@mentorcorp.com</user>
    </commit_message>
    <description>Initializes this server as the LDAP consumer by first creating a copy of the provider directory, then adding the syncrepl configuration to each configured database.

If the server is already setup as a consumer, the syncrepl configuration will be deleted, and recreated with the new settings.

If the server is a provider, the script will fail. This server will be identified as the provider if it's public IP address matches the DNS response for $LDAPREPLPROVIDER_HOSTNAME.

Requires the tools installed by the "LDAP Tools Install" RightScript.</description>
    <name>LDAP Initialize Consumer</name>
    <created_at>2010/10/18 20:15:04 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>1</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2010/10/18 20:15:08 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>RightScript</content_type>
    <commit_message>
      <text>Oops, forgot to update the attachment.  This is why the "TODO" in this script is so important.</text>
      <time>2010/10/18 19:29:35 +0000</time>
      <user>rgeyer@mentorcorp.com</user>
    </commit_message>
    <description>Installs some tools for OpenLDAP administration</description>
    <name>LDAP Tools Install</name>
    <created_at>2010/10/18 20:15:04 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>3</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2010/10/18 20:15:08 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>RightScript</content_type>
    <commit_message>
      <text>Ready to publish with OpenLDAP Directory Server v1 Server Template.</text>
      <time>2010/10/18 19:30:52 +0000</time>
      <user>rgeyer@mentorcorp.com</user>
    </commit_message>
    <description>Promotes this consumer to the provider for all configured databases by stripping the syncrepl configuration and changing the providers Dynamic DNS record to point to this server.

This script will fail if this server is already the provider.  This server will be identified as the provider if it's public IP address matches the DNS response for $LDAP_REPL_PROVIDER_HOSTNAME.

This script will fail if this server is not a consumer, or if it is a consumer for a different provider.

This script will not make any changes to the current provider, and it is recommended that once this script is run successfully you either terminate the old provider or execute "LDAP Initialize Consumer" on it to make it the new consumer.

Requires the tools installed by the "LDAP Tools Install" RightScript.</description>
    <name>LDAP Promote to Provider</name>
    <created_at>2010/10/18 20:15:04 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>1</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2010/10/18 20:15:08 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>RightScript</content_type>
    <commit_message>
      <text>Ready to publish with OpenLDAP Directory Server v1 Server Template.</text>
      <time>2010/10/18 19:30:16 +0000</time>
      <user>rgeyer@mentorcorp.com</user>
    </commit_message>
    <description>Sets the username/commonname and password for the OpenLDAP slapd.d config, also known as cn=config or real-time configuration.

Requires the tools installed by the "LDAP Tools Install" RightScript.</description>
    <name>LDAP Set Config Admin Details</name>
    <created_at>2010/10/18 20:15:04 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>2</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2010/10/18 20:15:08 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>RightScript</content_type>
    <commit_message>
      <text>Ready to publish with OpenLDAP Directory Server v1 Server Template.</text>
      <time>2010/10/18 19:34:34 +0000</time>
      <user>rgeyer@mentorcorp.com</user>
    </commit_message>
    <description>Installs the slapd and ldap utils (assumes Ubuntu).  Enables the bdb and hdb database modules, and any provided schemas.  Configures syslog-ng to record slapd log messages to local1, making them available in the RightScale dashboard.

Requires the tools installed by the "LDAP Tools Install" RightScript.</description>
    <name>LDAP Install OpenLDAP</name>
    <created_at>2010/10/18 20:15:05 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>2</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2010/10/18 20:15:09 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>RightScript</content_type>
    <commit_message>
      <text>Ready to publish with OpenLDAP Directory Server v1 Server Template.</text>
      <time>2010/10/18 19:30:10 +0000</time>
      <user>rgeyer@mentorcorp.com</user>
    </commit_message>
    <description>Sets the desired log level for the slapd daemon.
See &lt;a href="http://www.openldap.org/doc/admin24/slapdconf2.html#olcLogLevel: &lt;level&gt;"&gt;OpenLDAP 2.4 docs&lt;/a&gt; for more detail.

Requires the tools installed by the "LDAP Tools Install" RightScript.</description>
    <name>LDAP Set Log Level</name>
    <created_at>2010/10/18 20:15:06 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>1</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2010/10/18 20:15:09 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>RightScript</content_type>
    <commit_message>
      <text>Ready to publish with OpenLDAP Directory Server v1 Server Template.</text>
      <time>2010/10/18 19:30:02 +0000</time>
      <user>rgeyer@mentorcorp.com</user>
    </commit_message>
    <description>Loads one or more schemas from /etc/ldap/schema into the running slapd.  This will only add schemas which are not already present.  If the desired schema is dependent upon other schemas, you must supply them all in comma separated $LDAP_SCHEMA_LIST

Requires the tools installed by the "LDAP Tools Install" RightScript.</description>
    <name>LDAP Enable Schema(s)</name>
    <created_at>2010/10/18 20:15:06 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>2</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2010/10/18 20:15:09 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>RightScript</content_type>
    <commit_message>
      <text>Ready to publish with OpenLDAP Directory Server v1 Server Template.</text>
      <time>2010/10/18 19:29:54 +0000</time>
      <user>rgeyer@mentorcorp.com</user>
    </commit_message>
    <description>Enables a single OpenLDAP module.

Requires the tools installed by the "LDAP Tools Install" RightScript.</description>
    <name>LDAP Enable Module</name>
    <created_at>2010/10/18 20:15:06 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>1</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2010/10/18 20:15:09 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>RightScript</content_type>
    <commit_message>
      <text>Ready to publish with OpenLDAP Directory Server v1 Server Template.</text>
      <time>2010/10/18 19:29:46 +0000</time>
      <user>rgeyer@mentorcorp.com</user>
    </commit_message>
    <description>Creates an immediate backup of the slapd.d configuration, and all running slapd databases.  The slapd will be stopped for the duration of the backup!

Requires the tools installed by the "LDAP Tools Install" RightScript.</description>
    <name>LDAP DB S3 Backup</name>
    <created_at>2010/10/18 20:15:06 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>2</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2010/10/18 20:15:09 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>RightScript</content_type>
    <commit_message>
      <text>Ready to publish with OpenLDAP Directory Server v1 Server Template.</text>
      <time>2010/10/18 19:02:17 +0000</time>
      <user>rgeyer@mentorcorp.com</user>
    </commit_message>
    <description>Restores the slapd.d configuration, and all slapd databases from a backup created with the "LDAP DB S3 Backup" RightScript. The slapd will be stopped for the duration of the restoration!
Requires the tools installed by the "LDAP Tools Install" RightScript.</description>
    <name>LDAP DB S3 Restore</name>
    <created_at>2010/10/18 20:15:06 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>2</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2010/10/18 20:15:09 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>RightScript</content_type>
    <commit_message>
      <text>Ready to publish with OpenLDAP Directory Server v1 Server Template.</text>
      <time>2010/10/18 19:02:05 +0000</time>
      <user>rgeyer@mentorcorp.com</user>
    </commit_message>
    <description>Creates a daily cron file (assuming Ubuntu) which cleans up the backup history, keeping only $MAX_BACKUPS_TO_KEEP and creating a new backup for the day.  The new backup is created by running the same script (installed by the "LDAP Tools Install" RightScript) as the "LDAP DB S3 Backup" RightScript

Requires the tools installed by the "LDAP Tools Install" RightScript.</description>
    <name>LDAP DB S3 Enable Continuous Backup</name>
    <created_at>2010/10/18 20:15:07 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>2</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2010/10/18 20:15:09 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>RightScript</content_type>
    <commit_message>
      <text>Ready to publish with OpenLDAP Directory Server v1 Server Template.</text>
      <time>2010/10/18 19:01:14 +0000</time>
      <user>rgeyer@mentorcorp.com</user>
    </commit_message>
    <description>Deletes the daily cron file for continuous backups.</description>
    <name>LDAP DB S3 Disable Continuous Backup</name>
    <created_at>2010/10/18 20:15:07 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>2</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes>Initial Commit</revision_notes>
    <updated_at>2010/10/18 20:15:08 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>ServerTemplate</content_type>
    <commit_message>
      <text>Initial Commit</text>
      <time>2010/10/18 19:59:28 +0000</time>
      <user>rgeyer@mentorcorp.com</user>
    </commit_message>
    <description>This template will allow you to launch and maintain three different types of OpenLDAP servers.

1) A Stand-Alone OpenLDAP Server.
2) A Provider in a "refresh and persist" replication pair. Read all about it at -&gt; http://www.zytrax.com/books/ldap/ch7/#ol-syncrepl-rap
3) A Consumer in a "refresh and persist" replication pair.

Whichever type of server you launch, it will have the following super-neato features.

1) Can be backed up to an S3 bucket instantly using the "LDAP DB S3 Backup" operational RightScript
2) Can be restored from an S3 bucket instantly using the "LDAP DB S3 Restore" operational RightScript
3) Can be backed up daily to an S3 bucket using the "LDAP DB Enable Continuous Backup" operational RightScript
4) Set the log level for the slapd process using the "LDAP Set Log Level" operational RightScript, then monitor the log messages in the "local1" log file in the RightScale dashboard
5) A critical alert will be sent if ephemeral storage (where the LDAP database is stored) has less than 100MB free

The recommended configuration is to have two instances of this template running at any given time.  One in the Provider role, and one in the Consumer role.  This way you always have a hot spare ready to go in case anything should go wrong with the Provider, you can simply run the "LDAP Promote to Provider" operational RightScript on the Consumer, and be back up and running in minutes.

When the server is first launched and becomes operational, you'll have a fully operational OpenLDAP instance.  However no database will exist yet, you'll need to create one (or many) with the base naming context(s) you want.  Here's are some quick start guides for the three different server types.

----- Stand-Alone OpenLDAP Server -----
1) Launch the server
2) Run the "LDAP Create Database" operational RightScript to create your first database
3) If daily backups are desired, run the "LDAP DB S3 Enable Continuous Backup" operational RightScript
4) Put some stuff in your new LDAP database using your favorite directory tool.  (I really like the Apache Directory Studio!)

----- Provider OpenLDAP Server -----
1) Follow the steps from the Stand-Alone Server to launch this instance
2) Run the "LDAP Initialize Provider" operational RightScript
3) Enjoy!


----- Consumer OpenLDAP Server -----
1) Make sure you have another instance running which has already been configured using the steps for the Provider server
2) Follow the steps from the Stand-Alone Server to launch this instance
3) Run the "LDAP Initialize Consumer" operational RightScript
4) Enjoy!</description>
    <name>OpenLDAP Directory Server v1</name>
    <created_at>2010/10/18 20:15:08 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>1</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2010/10/19 00:32:47 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>RightScript</content_type>
    <commit_message>
      <text>Some syntax errors in ldapUtils.sh which prevented the promotion of a consumer to a provider.

exec != eval &amp;&amp; $1i != $1</text>
      <time>2010/10/19 00:26:46 +0000</time>
      <user>rgeyer@mentorcorp.com</user>
    </commit_message>
    <description>Installs some tools for OpenLDAP administration</description>
    <name>LDAP Tools Install</name>
    <created_at>2010/10/19 00:32:44 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>4</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes>Some syntax errors in ldapUtils.sh which prevented the promotion of a consumer to a provider.exec != eval &amp;&amp; $1i != $1</revision_notes>
    <updated_at>2010/10/19 00:32:46 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>ServerTemplate</content_type>
    <commit_message>
      <text>Had to change the name for the sake of public library submission.</text>
      <time>2010/10/19 00:31:34 +0000</time>
      <user>rgeyer@mentorcorp.com</user>
    </commit_message>
    <description>This template will allow you to launch and maintain three different types of OpenLDAP servers.

1. A Stand-Alone OpenLDAP Server.
2. A Provider in a "refresh and persist" replication pair. Read all about it [here](http://www.zytrax.com/books/ldap/ch7/#ol-syncrepl-rap)
3. A Consumer in a "refresh and persist" replication pair. Read all about it [here](http://www.zytrax.com/books/ldap/ch7/#ol-syncrepl-rap)

The recommended configuration is to have two instances of this template running at any given time.  One in the Provider role, and one in the Consumer role.  This way you always have a hot spare ready to go in case anything should go wrong with the Provider, you can simply run the *LDAP Promote to Provider* operational RightScript on the Consumer, and be back up and running in minutes.

Features
=====
Whichever type of server you launch, it will have the following super-neato features.

Backups
------
* Can be backed up to an S3 bucket instantly using the *LDAP DB S3 Backup* operational RightScript
* Can be restored from an S3 bucket instantly using the *LDAP DB S3 Restore* operational RightScript
* Can be backed up daily to an S3 bucket using the *LDAP DB Enable Continuous Backup* operational RightScript

Other super-neato stuff
-------------------
* Set the log level for the slapd process using the *LDAP Set Log Level* operational RightScript, then monitor the log messages in the "local1" log file in the RightScale dashboard
* A critical alert will be sent if ephemeral storage (where the LDAP database is stored) has less than 100MB free

Quick-Start Guides
============
When the server is first launched and becomes operational, you'll have a fully operational OpenLDAP instance.  However no database will exist yet, you'll need to create one (or many) with the base naming context(s) you want.  Here's are some quick start guides for the three different server types.

Stand-Alone OpenLDAP Server
-----------------------
1. Launch the server
2. Run the "LDAP Create Database" operational RightScript to create your first database
3. If daily backups are desired, run the "LDAP DB S3 Enable Continuous Backup" operational RightScript
4. Put some stuff in your new LDAP database using your favorite directory tool.  (I really like the Apache Directory Studio!)

Provider OpenLDAP Server
--------------------
1. Follow the steps from the Stand-Alone Server to launch this instance
2. Run the "LDAP Initialize Provider" operational RightScript
3. Enjoy!

Consumer OpenLDAP Server
---------------------
1. Make sure you have another instance running which has already been configured using the steps for the Provider server
2. Follow the steps from the Stand-Alone Server to launch this instance
3. Run the "LDAP Initialize Consumer" operational RightScript
4. Enjoy!</description>
    <name>OpenLDAP Directory Server v1.1</name>
    <created_at>2010/10/19 00:32:45 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>3</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2010/10/21 20:21:30 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>RightScript</content_type>
    <commit_message>
      <text>Initial Commit</text>
      <time>2010/10/21 19:59:35 +0000</time>
      <user>rgeyer@mentorcorp.com</user>
    </commit_message>
    <description>Backup a particular DB/schema to s3, using mysqldump.</description>
    <name>DB MySQL s3 mysqldump backup (Optional) v1</name>
    <created_at>2010/10/21 20:21:24 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>1</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2010/10/21 20:21:30 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>RightScript</content_type>
    <commit_message>
      <text>Initial Commit</text>
      <time>2010/10/21 19:58:14 +0000</time>
      <user>rgeyer@mentorcorp.com</user>
    </commit_message>
    <description></description>
    <name>DB MySQL Initialize Empty DB</name>
    <created_at>2010/10/21 20:21:25 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>1</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2010/10/21 20:21:30 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>RightScript</content_type>
    <commit_message>
      <text>Initial Commit</text>
      <time>2010/10/21 19:58:43 +0000</time>
      <user>rgeyer@mentorcorp.com</user>
    </commit_message>
    <description>Checkout the sources from an s3 tarball.
Skips the update/retrieval of code if the bucket and package are not set.</description>
    <name>WEB app s3 code checkout w/ get latest support v1</name>
    <created_at>2010/10/21 20:21:25 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>1</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2010/10/21 20:21:30 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>RightScript</content_type>
    <commit_message>
      <text>Initial Commit</text>
      <time>2010/10/21 19:56:40 +0000</time>
      <user>rgeyer@mentorcorp.com</user>
    </commit_message>
    <description>Runs one or more LDIF files pulled from a file stored in an S3 storage bucket at boot time.  This is intended to initialize the empty OpenLDAP database created by the ["LDAP Create Database"](http://www.rightscale.com/library/right_scripts/LDAP-Create-Database/12345) RightScript.&#13;
&#13;
&#13;
&#13;
Requires the tools installed by the ["LDAP Tools Install"](http://www.rightscale.com/library/right_scripts/LDAP-Tools-Install/12345) RightScript.</description>
    <name>LDAP Execute LDIF File(s) at boot</name>
    <created_at>2010/10/21 20:21:25 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>1</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2010/10/21 20:21:30 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>RightScript</content_type>
    <commit_message>
      <text>Initial Commit</text>
      <time>2010/10/21 20:04:47 +0000</time>
      <user>rgeyer@mentorcorp.com</user>
    </commit_message>
    <description>Runs one or more LDIF files pulled from a file stored in an S3 storage bucket.&#13;
&#13;
&#13;
&#13;
Requires the tools installed by the ["LDAP Tools Install"](http://www.rightscale.com/library/right_scripts/LDAP-Tools-Install/12345) RightScript.</description>
    <name>LDAP Execute LDIF File(s)</name>
    <created_at>2010/10/21 20:21:25 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>1</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2010/10/21 20:21:30 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>RightScript</content_type>
    <commit_message>
      <text>Initial Commit</text>
      <time>2010/10/21 19:57:23 +0000</time>
      <user>rgeyer@mentorcorp.com</user>
    </commit_message>
    <description>First Boot Slave Start

**Description**

This RightScript performs the following actions:
* Makes a local Slave copy of the current Master DB.
* Starts this server as a MySQL Slave to a Master DB.
* Sets up the correct configuration file for a reboot to continue the slave role.

**First Launch**

Boot-time version of slave initialization. Can be enabled/disabled by setting:

* INIT\_SLAVE\_AT\_BOOT = true/false

_NOTE:_ Setting the value to $ignore is equivalent to true.

When enabled, it performs the same actions as its counterpart in the operational script's list: 
* Converts a running DB instance to be a slave of an existing Master DB. 
* Snapshot and pull the necessary files of the running master. 
* Set the slave DNS entry to point to the instance's IP.

**Reboot**

No action is taken at all. MySQL just restarts and resumes its past role.
* If the Slave was started, it continues.
* If the Slave was not started, it stays the same.
</description>
    <name>DB EBS init at boot (Optional) v1</name>
    <created_at>2010/10/21 20:21:25 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>1</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2010/10/21 20:21:30 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>RightScript</content_type>
    <commit_message>
      <text>Initial Commit</text>
      <time>2010/10/21 19:57:49 +0000</time>
      <user>rgeyer@mentorcorp.com</user>
    </commit_message>
    <description>It downloads a mysqldump file from s3 and imports it into the local server (on database DB_SCHEMA_NAME).
If the schema already exists, nothing will be changed in the DB (i.e., no import).
If the DB_MYSQLDUMP_PREFIX and DB_MYSQLDUMP_BUCKET are not set (input variable marked as ignored), nothing will be done. </description>
    <name>DB MySQL s3 mysqldump import (Optional) v1</name>
    <created_at>2010/10/21 20:21:26 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>1</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2010/10/21 20:21:30 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>RightScript</content_type>
    <commit_message>
      <text>Initial Commit</text>
      <time>2010/10/21 19:59:09 +0000</time>
      <user>rgeyer@mentorcorp.com</user>
    </commit_message>
    <description>Install a cron job to perform a nightly backup of a db (DB_SCHEMA_NAME), using mysqldump, and save it to s3.
If bucket and prefix input variables are not set (or set to ignore) no cron will be created.</description>
    <name>DB MySQL s3 continuous mysqldump backups (Optional) v1</name>
    <created_at>2010/10/21 20:21:27 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>1</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes>Initial Commit</revision_notes>
    <updated_at>2010/10/21 20:21:30 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>ServerTemplate</content_type>
    <commit_message>
      <text>Initial Commit</text>
      <time>2010/10/21 20:18:02 +0000</time>
      <user>rgeyer@mentorcorp.com</user>
    </commit_message>
    <description>If you're using the RightScale premium server templates [Tomcat6 FrontEnd v9](http://www.rightscale.com/library/server_templates/Tomcat6-FrontEnd-v9/12345) and [Tomcat6 App Server v9](http://www.rightscale.com/library/server_templates/Tomcat6-App-Server-v9/12345) with a database on [MySQL 5.1 EBS v2](http://www.rightscale.com/library/server_templates/MySQL-5-1-EBS-v2/12345) and authentication with LDAP using my [OpenLDAP Directory Server v1.1](http://www.rightscale.com/library/server_templates/OpenLDAP-Directory-Server-v1-1/12345) to run your Java or Grails application in production, you need this template for development, QA, and testing!

***

This template allows you to setup a single server which hosts all of the services provided by the servers you run in production.  This allows you to setup ancillary environments (QA, Staging, Development) which *almost* exactly mirror your production environment.

MySQL Database Options
-------------------
The template is also very flexible and configurable.  You can choose to load the database directly from the latest EBS snapshot of production, create a new empty database at boot, or restore the database from a previous S3 backup.

By loading the database from the production EBS snapshot you can quickly and easily create an instant mirror of your production server for testing new code, or a big update, or troubleshooting a problem in production.

By loading the database from an S3 backup you can run an on demand QA box with a psuedo persistent database backed up to S3 on a regular basis.  When your QA cycle is done, terminate the box secure in the knowledge that your configuration and QA data is still intact ready for the next QA cycle.

By creating a new empty database you have the freedom to populate it from scripts or other arbitrary backups, making an excellent development and test platform for specific issues and odd data combinations.

LDAP Options
-----------
If your application uses LDAP for authentication, you can launch an instance and load LDIF files stored in an S3 bucket.  If you're not using LDAP, you can opt to disable this service entirely.

Best Practices
-----------
Since this template does run so many services, it's highly recommended that you launch it on an **m1.large** instance.  If you don't you're likely consume nearly all of the memory of an **m1.small** and will get critical alerts about low available memory.  Depending on your application, you might be willing/able to ignore these, but it's something you should be aware of.</description>
    <name>Tomcat6 Java or Grails (App, FrontEnd, Database &amp; LDAP) - All In One v1</name>
    <created_at>2010/10/21 20:21:27 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>1</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2010/10/29 04:54:17 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>RightScript</content_type>
    <commit_message>
      <text>Ready to be published with the Dev All-in-One ServerTemplate</text>
      <time>2010/10/29 03:18:19 +0000</time>
      <user>rgeyer@mentorcorp.com</user>
    </commit_message>
    <description>Installs git and gitosis.  The gitosis installation is intialized using the private key supplied in $OPT_GITOSIS_KEY.

**After Install**
From a system that has the same private key, you can run the following commands to further configure and use gitosis.

* Use the  *SCM GIT Initialize Repository* RightScript to create a new repository
* git clone git@&lt;EC2_PUBLIC_IPV4&gt;:gitosis_admin.git
* Grant access to new repository as needed by making changes to gitosis-admin/gitosis.conf
* git clone git@&lt;EC2_PUBLIC_IPV4&gt;:&lt;new repository path&gt;</description>
    <name>SCM GIT &amp; Gitosis Install</name>
    <created_at>2010/10/29 04:54:09 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>2</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2010/10/29 04:54:17 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>RightScript</content_type>
    <commit_message>
      <text>Initial Commit</text>
      <time>2010/10/29 03:43:57 +0000</time>
      <user>rgeyer@mentorcorp.com</user>
    </commit_message>
    <description>Backs up the entire gitosis configuration and git repositories.  It's frankly a bit slow to backup a reasonable sized repo to S3, and switching to EBS is in the works, but this works for data redundancy and easily migrating a repo to a different instance.</description>
    <name>SCM GIT &amp; Gitosis Backup to S3</name>
    <created_at>2010/10/29 04:54:10 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>1</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2010/10/29 04:54:17 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>RightScript</content_type>
    <commit_message>
      <text>Initial Commit</text>
      <time>2010/10/29 03:48:32 +0000</time>
      <user>rgeyer@mentorcorp.com</user>
    </commit_message>
    <description>Restores the most recent backup with the $GITOSIS_BKUP_PREFIX from the $GITOSIS_BKUP_BUCKET S3 bucket.  Useful for moving a git repo to a different instance, or for disaster recovery</description>
    <name>SCM GIT &amp; Gitosis Restore from S3</name>
    <created_at>2010/10/29 04:54:10 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>1</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2010/10/29 04:54:17 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>RightScript</content_type>
    <commit_message>
      <text>Initial Commit</text>
      <time>2010/10/29 03:51:44 +0000</time>
      <user>rgeyer@mentorcorp.com</user>
    </commit_message>
    <description>Enables a daily backup (using Ubuntu daily cron) of the gitosis configuration and git repo to S3</description>
    <name>SCM GIT &amp; Gitosis Enable Continuous Backup</name>
    <created_at>2010/10/29 04:54:10 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>1</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2010/10/29 04:54:17 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>RightScript</content_type>
    <commit_message>
      <text>Initial Commit</text>
      <time>2010/10/29 03:45:39 +0000</time>
      <user>rgeyer@mentorcorp.com</user>
    </commit_message>
    <description>Disables the daily backup of the gitosis configuration and git repo to S3</description>
    <name>SCM GIT &amp; Gitosis Disable Continuous Backup</name>
    <created_at>2010/10/29 04:54:10 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>1</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2010/10/29 04:54:17 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>RightScript</content_type>
    <commit_message>
      <text>All ready to use in the Dev All-in-One template</text>
      <time>2010/10/29 02:46:24 +0000</time>
      <user>rgeyer@mentorcorp.com</user>
    </commit_message>
    <description>Sets up an apache vhost based on the configuration created by the [WEB apache base install v7 RightScript](http://www.rightscale.com/library/right_scripts/WEB-apache-base-install-v7/12345)</description>
    <name>WEB Apache simple vhost configure</name>
    <created_at>2010/10/29 04:54:11 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>2</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2010/10/29 04:54:17 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>RightScript</content_type>
    <commit_message>
      <text>Initial Commit</text>
      <time>2010/10/29 03:54:43 +0000</time>
      <user>rgeyer@mentorcorp.com</user>
    </commit_message>
    <description>Creates a new repository at $GITOSIS_HOME that's all ready to go.  Don't forget to enable access in gitosis-admin/gitosis.conf</description>
    <name>SCM GIT Initialize Bare Repository</name>
    <created_at>2010/10/29 04:54:11 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>1</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2010/10/29 04:54:17 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>RightScript</content_type>
    <commit_message>
      <text>Initial Commit</text>
      <time>2010/10/29 04:05:38 +0000</time>
      <user>rgeyer@mentorcorp.com</user>
    </commit_message>
    <description>Installs the [TeamCity 5.1.5 Continuous Integration](http://www.jetbrains.com/teamcity/) server and makes it available at $WEBSITE_DNS/teamcity/.

Uses a MySQL database to store configuration data.  A new database with the name *teamcity* is created, along with a new database user specifically for the app.</description>
    <name>CI TeamCity 5.1 Install</name>
    <created_at>2010/10/29 04:54:11 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>1</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2010/10/29 04:54:17 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>RightScript</content_type>
    <commit_message>
      <text>Initial Commit</text>
      <time>2010/10/29 04:10:09 +0000</time>
      <user>rgeyer@mentorcorp.com</user>
    </commit_message>
    <description>Backs up the $TEAMCITY_HOME/data and MySQL database configuration to an S3 bucket.</description>
    <name>CI TeamCity 5.1 Backup to S3</name>
    <created_at>2010/10/29 04:54:11 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>1</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2010/10/29 04:54:17 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>RightScript</content_type>
    <commit_message>
      <text>Initial Commit</text>
      <time>2010/10/29 02:56:29 +0000</time>
      <user>rgeyer@mentorcorp.com</user>
    </commit_message>
    <description>Enables the JK Module (mod_jk) for the apache vhost identified by $WEBSITE_DNS.  Also sets up the Tomcat6 deployment manager application with the specified user credentials, and maps it to $WEBSITE_DNS/manager/html</description>
    <name>WEB Apache enable mod_jk</name>
    <created_at>2010/10/29 04:54:12 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>1</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2010/10/29 04:54:17 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>RightScript</content_type>
    <commit_message>
      <text>Initial Commit</text>
      <time>2010/10/29 04:13:27 +0000</time>
      <user>rgeyer@mentorcorp.com</user>
    </commit_message>
    <description>Restores the most recent backup with the $TEAMCITY_BKUP_PREFIX from the $TEAMCITY_BKUP_BUCKET S3 bucket. Useful for moving teamcity to a different instance, or for disaster recovery</description>
    <name>CI TeamCity 5.1 Restore from S3</name>
    <created_at>2010/10/29 04:54:12 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>1</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2010/10/29 04:54:17 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>RightScript</content_type>
    <commit_message>
      <text>Initial Commit</text>
      <time>2010/10/29 03:09:21 +0000</time>
      <user>rgeyer@mentorcorp.com</user>
    </commit_message>
    <description>A minor adjustment to the [DB MySQL 5.0 server install v8 script](http://www.rightscale.com/library/right_scripts/DB-MySQL-5-0-server-install-v8/12345). It's been gutted of all CentOS support, and it now creates the db admin user that get's used throughout.


Installs MySQL on server, configured and started.

**Description** 

Configures MySQL with one of the predefined templates based on the instance type.

Currently 2 main option types exist:

 * dedicated (where the mysql config allocates all existing resources of the machine)
 * shared (where the mysql is configured to use less resources so that it can be run concurrently with other apps like apache and rails for example)

The name of the input variable must match the name of an attachment, without the extension. 

**First launch** 

Installed and configures database.  All old configuration is replaced and mysql is installed with a new mysql default database. This version of the script will configure the placements of binlogs in a directory different from the data directory.

**Reboot** 

This script is skipped on a REBOOT of the server.  The MySQL Server is restarted.
</description>
    <name>DB MySQL 5.0 server install v1</name>
    <created_at>2010/10/29 04:54:12 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>1</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2010/10/29 04:54:17 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>RightScript</content_type>
    <commit_message>
      <text>Initial Commit</text>
      <time>2010/10/29 04:17:34 +0000</time>
      <user>rgeyer@mentorcorp.com</user>
    </commit_message>
    <description>Enables a daily backup (using Ubuntu daily cron) of teamcity to S3</description>
    <name>CI TeamCity 5.1 Enable Continuous Backup</name>
    <created_at>2010/10/29 04:54:13 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>1</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2010/10/29 04:54:17 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>RightScript</content_type>
    <commit_message>
      <text>Initial Commit</text>
      <time>2010/10/29 04:18:48 +0000</time>
      <user>rgeyer@mentorcorp.com</user>
    </commit_message>
    <description>Disables the daily backup of teamcity to S3</description>
    <name>CI TeamCity 5.1 Disable Continuous Backup</name>
    <created_at>2010/10/29 04:54:13 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>1</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2010/10/29 04:54:17 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>RightScript</content_type>
    <commit_message>
      <text>Initial Commit</text>
      <time>2010/10/29 04:25:31 +0000</time>
      <user>rgeyer@mentorcorp.com</user>
    </commit_message>
    <description>Installs the [Artifactory 2.3.0](http://www.jfrog.org/products.php) server and makes it available at $WEBSITE_DNS/artifactory/.

Uses a MySQL database to store configuration data.  A new database with the name *artifactory* is created, along with a new database user specifically for the app.</description>
    <name>SCM Artifactory 2.3.0 OSS Install</name>
    <created_at>2010/10/29 04:54:13 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>1</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2010/10/29 04:54:17 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>RightScript</content_type>
    <commit_message>
      <text>Initial Commit</text>
      <time>2010/10/29 04:28:39 +0000</time>
      <user>rgeyer@mentorcorp.com</user>
    </commit_message>
    <description>Backs up the $ARTIFACTORY_HOME/data/filestore and MySQL database configuration to an S3 bucket.</description>
    <name>SCM Artifactory 2.3.0 OSS Backup to S3</name>
    <created_at>2010/10/29 04:54:14 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>1</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2010/10/29 04:54:17 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>RightScript</content_type>
    <commit_message>
      <text>Initial Commit</text>
      <time>2010/10/29 04:31:46 +0000</time>
      <user>rgeyer@mentorcorp.com</user>
    </commit_message>
    <description>Restores the most recent backup with the $ARTIFACTORY_BKUP_PREFIX from the $ARTIFACTORY_BKUP_BUCKET S3 bucket. Useful for moving artifactory to a different instance, or for disaster recovery</description>
    <name>SCM Artifactory 2.3.0 OSS Restore from S3</name>
    <created_at>2010/10/29 04:54:14 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>1</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2010/10/29 04:54:17 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>RightScript</content_type>
    <commit_message>
      <text>Initial Commit</text>
      <time>2010/10/29 04:34:58 +0000</time>
      <user>rgeyer@mentorcorp.com</user>
    </commit_message>
    <description>Enables a daily backup (using Ubuntu daily cron) of artifactory to S3</description>
    <name>SCM Artifactory 2.3.0 OSS Enable Continuous Backup</name>
    <created_at>2010/10/29 04:54:14 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>1</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2010/10/29 04:54:17 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>RightScript</content_type>
    <commit_message>
      <text>Initial Commit</text>
      <time>2010/10/29 04:36:04 +0000</time>
      <user>rgeyer@mentorcorp.com</user>
    </commit_message>
    <description>Disables the daily backup of artifactory to S3</description>
    <name>SCM Artifactory 2.3.0 OSS Disable Continuous Backup</name>
    <created_at>2010/10/29 04:54:14 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>1</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes>Initial publish to the library</revision_notes>
    <updated_at>2010/10/29 04:54:17 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>ServerTemplate</content_type>
    <commit_message>
      <text>Ooops, forgot to set the default inputs to something sensible.</text>
      <time>2010/10/29 04:50:41 +0000</time>
      <user>rgeyer@mentorcorp.com</user>
    </commit_message>
    <description>Starting a new development group, or project?  Need version control, continuous integration, and library management?  Look no further!

Description
=======
This server template is being used to host all of the services for our development team.  Git and gitosis for version control, TeamCity for continuous integration, and Artifactory for library management.

Quick Start
=======
When the server first starts up, it will be running Tomcat6, Apache, and MySQL with monitoring, but none of the actual development services.  The installation and configuration scripts for those services are setup as operational scripts to allow you to only fire up the services you need.

You can just as easily clone the server template and move the install scripts from operation to boot, they're designed to work either way.

Don't forget to enable continuous backups for the services you run, just in case you need to setup a new instance in case of a disaster, or to move your dev system to a bigger instance.</description>
    <name>Dev Team All in One v1</name>
    <created_at>2010/10/29 04:54:15 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>2</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2010/10/29 17:39:04 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>RightScript</content_type>
    <commit_message>
      <text>Fixed the descriptions of the inputs.  The good news is that they worked correctly, they were just mislabeled in this script as compared to the Install script. :-)</text>
      <time>2010/10/29 17:29:35 +0000</time>
      <user>rgeyer@mentorcorp.com</user>
    </commit_message>
    <description>Sets the username/commonname and password for the OpenLDAP slapd.d config, also known as cn=config or real-time configuration.

Requires the tools installed by the "LDAP Tools Install" RightScript.</description>
    <name>LDAP Set Config Admin Details</name>
    <created_at>2010/10/29 17:39:02 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>3</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes>Added some defaults, and functionality to load arbitrary LDIF File(s) from S3 at boot or from an operational script!</revision_notes>
    <updated_at>2010/10/29 17:39:03 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>ServerTemplate</content_type>
    <commit_message>
      <text>Added some defaults, and functionality to load arbitrary LDIF File(s) from S3 at boot or from an operational script!</text>
      <time>2010/10/29 17:36:55 +0000</time>
      <user>rgeyer@mentorcorp.com</user>
    </commit_message>
    <description>This template will allow you to launch and maintain three different types of OpenLDAP servers.

1. A Stand-Alone OpenLDAP Server.
2. A Provider in a "refresh and persist" replication pair. Read all about it [here](http://www.zytrax.com/books/ldap/ch7/#ol-syncrepl-rap)
3. A Consumer in a "refresh and persist" replication pair. Read all about it [here](http://www.zytrax.com/books/ldap/ch7/#ol-syncrepl-rap)

The recommended configuration is to have two instances of this template running at any given time.  One in the Provider role, and one in the Consumer role.  This way you always have a hot spare ready to go in case anything should go wrong with the Provider, you can simply run the *LDAP Promote to Provider* operational RightScript on the Consumer, and be back up and running in minutes.

Features
=====
Whichever type of server you launch, it will have the following super-neato features.

New in Rev4
---------
* You can now run one or many LDIF files (stored in an S3 bucket) against the database at startup, or at any time using an operational script.
* Added a few more defaults, in particular a list of schemas to get started (core,cosine,inetorgperson, which we use for our application)

Backups
------
* Can be backed up to an S3 bucket instantly using the *LDAP DB S3 Backup* operational RightScript
* Can be restored from an S3 bucket instantly using the *LDAP DB S3 Restore* operational RightScript
* Can be backed up daily to an S3 bucket using the *LDAP DB Enable Continuous Backup* operational RightScript

Other super-neato stuff
-------------------
* Set the log level for the slapd process using the *LDAP Set Log Level* operational RightScript, then monitor the log messages in the "local1" log file in the RightScale dashboard
* A critical alert will be sent if ephemeral storage (where the LDAP database is stored) has less than 100MB free

Quick-Start Guides
============
When the server is first launched and becomes operational, you'll have a fully operational OpenLDAP instance.  However no database will exist yet, you'll need to create one (or many) with the base naming context(s) you want.  Here's are some quick start guides for the three different server types.

Stand-Alone OpenLDAP Server
-----------------------
1. Launch the server
2. Run the "LDAP Create Database" operational RightScript to create your first database
3. If daily backups are desired, run the "LDAP DB S3 Enable Continuous Backup" operational RightScript
4. Put some stuff in your new LDAP database using your favorite directory tool.  (I really like the Apache Directory Studio!)

Provider OpenLDAP Server
--------------------
1. Follow the steps from the Stand-Alone Server to launch this instance
2. Run the "LDAP Initialize Provider" operational RightScript
3. Enjoy!

Consumer OpenLDAP Server
---------------------
1. Make sure you have another instance running which has already been configured using the steps for the Provider server
2. Follow the steps from the Stand-Alone Server to launch this instance
3. Run the "LDAP Initialize Consumer" operational RightScript
4. Enjoy!</description>
    <name>OpenLDAP Directory Server v1.1</name>
    <created_at>2010/10/29 17:39:02 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>4</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2010/10/30 00:55:56 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>RightScript</content_type>
    <commit_message>
      <text>Initial Commit</text>
      <time>2010/10/30 00:53:40 +0000</time>
      <user>rgeyer@mentorcorp.com</user>
    </commit_message>
    <description></description>
    <name>WEB PHP5 &amp; ImageMagick Install</name>
    <created_at>2010/10/30 00:55:55 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>1</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2010/10/30 00:55:56 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>RightScript</content_type>
    <commit_message>
      <text>Initial Commit</text>
      <time>2010/10/30 00:45:53 +0000</time>
      <user>rgeyer@mentorcorp.com</user>
    </commit_message>
    <description>Installs two php files that are hosted at $WEBSITE_DNS/resizer/.  An index.php file that is used to demonstrate the functionality of the script, and a resizer.php file which accepts a file attachment and a series of inputs from POST.

You can find the code in github at http://github.com/rgeyer/RESTful-PHP-Resizer.  This script uses the tag rs-script-rev1</description>
    <name>APP Install PHP LANCZOS Image Resizer</name>
    <created_at>2010/10/30 00:55:55 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>1</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes>Initial Commit</revision_notes>
    <updated_at>2010/10/30 00:55:56 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>ServerTemplate</content_type>
    <commit_message>
      <text>Initial Commit</text>
      <time>2010/10/30 00:54:44 +0000</time>
      <user>rgeyer@mentorcorp.com</user>
    </commit_message>
    <description>Sets up a nice environment to run my PHP RESTFul image resizer.  A simple app I threw together to explore a theory.  You can get the code for it at [github](http://github.com/rgeyer/RESTful-PHP-Resizer)

Description
=======
Sets up an Ubuntu box with Apache2 and PHP configured and precious little else.  This is intended to be a VERY lightly loaded application server that will convert images in bulk.

Check out the [github](http://github.com/rgeyer/RESTful-PHP-Resizer) repo for more details on the actual script.</description>
    <name>ImageMagick Resizer</name>
    <created_at>2010/10/30 00:55:55 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>1</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2011/01/18 17:21:57 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>CookbookRepoSequence</content_type>
    <commit_message>
      <text>Added support for maint pages in ssl reverse proxy, some tagging, and support for http proxying and forcing https.</text>
      <time>2011/01/18 04:53:13 +0000</time>
      <user>me@ryangeyer.com</user>
    </commit_message>
    <description></description>
    <name>Linux RightLink 5.6 Compatible</name>
    <created_at>2011/01/18 17:21:56 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>3</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes>Initial Commit..   Alpha1</revision_notes>
    <updated_at>2011/01/18 17:21:57 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>ServerTemplate</content_type>
    <commit_message>
      <text>Initial Commit..   Alpha1</text>
      <time>2011/01/18 05:02:05 +0000</time>
      <user>me@ryangeyer.com</user>
    </commit_message>
    <description>A reverse proxy server configured using Apache2.  This is intended to overcome the issue of having only a single assignable IP address for any EC2 instance.  Setting one of these server instances up allows you to use the IP address assigned to it to forward traffic to a single backend box which may be running many SSL sites on different ports.

Effectively, you're paying $6.11(reserved) or $15.60(on-demand) per month for an additional IP address.  This makes the most sense if you're running a single (big) windows instance to back many of these proxies, which coincidentally is exactly the way that we're using it.

FAQ
---
* Why not use nginx?
  I probably will in the future since it's a bit more conservative about memory and CPU use, but I needed to create this reasonably quickly and get it working in our environment.  I was comfortable with Apache2 and knew it could do the job, so it was the easy choice for rapid deployment.
* What's up with the "Alpha" designation?
  This ServerTemplate uses Chef, which is still in beta on the RightScale management platform, plus this is the first revision of the ServerTemplate to be published.  That said, this ServerTemplate is in use in production in our environment, and has been tested pretty thoroughly.  Feel free to let me know if you have any problems with this!
* How come no load balancing?
  There are other ServerTemplates for that, and our use case doesn't necessitate load balancing.

ToDo
----
* Add support for a maintenance page/mode
* Add support for a (god forbid) outage page/mode</description>
    <name>Apache2 SSL Reverse Proxy - Alpha1</name>
    <created_at>2011/01/18 17:21:56 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>1</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes>Initial Commit</revision_notes>
    <updated_at>2011/01/25 01:47:24 +0000</updated_at>
    <publisher>Ryan Geyer</publisher>
    <content_type>RightScript</content_type>
    <commit_message>
      <text>Initial Commit</text>
      <time>2011/01/25 01:43:52 +0000</time>
      <user>me@ryangeyer.com</user>
    </commit_message>
    <description>Adds the Ruby bins path to the systems %PATH% variable for the RightScale user only.

This is most useful for doing stuff in Chef that requires a properly setup Ruby environment.  That is, in fact, how I am using it most frequently in my "unisex" (windows and *nix) cookbooks.  https://github.com/rgeyer/cookbooks</description>
    <name>SYS Add RightScale Sandbox to Path (Windows)</name>
    <created_at>2011/01/25 01:47:24 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>1</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes>Switched to a more Powershell friendly syntax.  Also setting the environment for the "current" execution as well as any future ones, since RightLink seems to run this atomically with the rest of the recipes in a boot bundle.</revision_notes>
    <updated_at>2011/01/25 21:00:47 +0000</updated_at>
    <publisher>Ryan Geyer</publisher>
    <content_type>RightScript</content_type>
    <commit_message>
      <text>Switched to a more Powershell friendly syntax.  Also setting the environment for the "current" execution as well as any future ones, since RightLink seems to run this atomically with the rest of the recipes in a boot bundle.</text>
      <time>2011/01/25 21:00:10 +0000</time>
      <user>me@ryangeyer.com</user>
    </commit_message>
    <description>Adds the Ruby bins path to the systems %PATH% variable for the RightScale user only.

This is most useful for doing stuff in Chef that requires a properly setup Ruby environment.  That is, in fact, how I am using it most frequently in my "unisex" (windows and *nix) cookbooks.  https://github.com/rgeyer/cookbooks</description>
    <name>SYS Add RightScale Sandbox to Path (Windows)</name>
    <created_at>2011/01/25 21:00:47 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>2</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2011/02/11 20:27:46 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>CookbookRepoSequence</content_type>
    <commit_message>
      <text>Stable Branches for Linux &amp; RightLink 5.6.</text>
      <time>2011/02/02 20:16:33 +0000</time>
      <user>me@ryangeyer.com</user>
    </commit_message>
    <description></description>
    <name>Linux RightLink 5.6 Compatible</name>
    <created_at>2011/02/02 20:17:12 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>5</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2011/02/03 21:09:11 +0000</updated_at>
    <publisher>Ryan Geyer</publisher>
    <content_type>CookbookRepoSequence</content_type>
    <commit_message>
      <text>Stable branches for distribution of a beta version of my AIO ServerTemplate.</text>
      <time>2011/02/02 20:16:01 +0000</time>
      <user>me@ryangeyer.com</user>
    </commit_message>
    <description></description>
    <name>Web &amp; Email vhost AIO</name>
    <created_at>2011/02/03 21:09:09 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>2</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes>Beta Rev1 - Initial Commit</revision_notes>
    <updated_at>2011/12/08 18:19:39 +0000</updated_at>
    <publisher>Ryan Geyer</publisher>
    <content_type>ServerTemplate</content_type>
    <commit_message>
      <text>Beta Rev1 - Initial Commit</text>
      <time>2011/02/03 20:08:45 +0000</time>
      <user>me@ryangeyer.com</user>
    </commit_message>
    <description># Description #
This is an All-In-One (AIO) server for hosting web sites/applications and email for one or many domain names (virtual hosting).

## Total Cost of Ownership ##
This ServerTemplate is designed to run within the confines of a [t1.micro](http://aws.amazon.com/ec2/instance-types/) EC2 instance.  A t1.micro instance requires that you use an EBS volume to store the operating system.  The MultiCloud Image this ServerTemplate uses automatically creates a 10GB EBS volume for this purpose.

This server template requires one additional EBS volume for storing configuration and application data, the size of which will vary based on what you're running.

When you first sign up for AWS you can take advantage of their [free tier](http://aws.amazon.com/free/) for all services for one year.  Aside from the EBS volume for storing configuration and application data, all other usage of this template falls within the free tier.

While using this server template I've averaged $0.12 per month between EIP data transfer costs, and the additional EBS volume.

After one year when the free tier expires, you can expect to spend under $15 per month if you pay for a t1.micro reserved instance, broken down thusly.

* t1.micro reservation for 1 year $54 ($4.50/mo but billed once at the beginning)
* 730hr t1.micro usage @$0.007/hr (Reserved cost in US-EAST cloud) $5.11/mo
* 10GB EBS Volume $1.00/mo
* 1GB EBS Volume $0.10/mo
* 7GB EBS Snapshot Storage (The 1GB configuration/application data volume, full, with 7 days of history, which is the default) $1.05/mo

That totals out to $11.76/mo, which leaves $3.24 for data transfer, I/O requests and maybe some S3 storage.

As I personally run this more, I'll be able to give some more real world data, rather than just estimates.  The point though, is that this is dirt cheap given the control you have!

## LAMP Virtual Hosting ##
The web hosting environment is a full LAMP stack consisting of;

* Linux - Ubuntu 10.04
* Apache2 - 2.2.14 (Ubuntu 8.4)
* MySQL - 5.1.41-3 (Ubuntu 12.9)
* PHP - 5.3.2-1 (Ubuntu 4.7)

## Email Virtual Hosting ##
In addition to the LAMP stack, a Postfix server is installed and configured for virtual hosting of one or many email domains.  Currently, the postfix server is configured to relay email for configured email addresses (more information on that below) to one or more other email addresses.  I use this to accept email for a domain, and effectively "forward" it to my gmail account where I manage all of my email.

## Developer Tools &amp; Libraries ##
There are also some services and libraries which get installed that will be useful for developers, and which I depend upon for my instance of the server.

* Zend Framework - 1.11.1
* Gitosis - Latest HEAD revision from git://eagain.net/gitosis.git

# Usage #

## Prerequisites ##

### Elastic IP ###
It is *HIGHLY* recommended that you setup an Elastic IP for your server instance.  This will make things like vertical scaling and disaster recovery easier.

Also, if you're going to be serious about running an email server, using an EIP is the only way to go so you don't get blacklisted etc.  Setup an EIP, then make sure you fill out [this form](https://aws-portal.amazon.com/gp/aws/html-forms-controller/contactus/ec2-email-limit-rdns-request) to setup a reverse DNS record for your hostname (like mail.yourdomain.com) to your EIP.  You can read about why this is important [here](http://www.simpledns.com/kb.aspx?kbid=1052)

### Security Groups ###
You'll need to be able to communicate with your server from the interwebs.  This means you'll need to open some ports in one or more security groups, and add your server instance to those security groups.

As a best practice, try to avoid making all of your changes to the "default" security group.  It's also better if you put the ports for each service in it's own security group, though just one security group which opens all ports for this server instance is probably okay too.  Here are the ports that are required to be able to communicate with this server.

* SSH - TCP:22
* SMTP - TCP:25
* HTTP - TCP:80
* HTTPS - TCP:443
* GIT - TCP:9418

## Launching for the first time ##
If you've just imported this ServerTemplate from the library, here's what you need to know to get started.

### Inputs ###
* Database Admin Password

  Pick a secure password for the database administrator.  The default administrator username is "administrator".  It's possible that you'll never need to use these credentials since the Chef recipes set everything up for you, but it's good to have in case of emergency or for administrative tasks not covered in an operational script etc.
* Gitosis Private Key

  You can leave this blank, in which case a new SSH RSA key will be created for Gitosis to use.  Best practice is to use a key which has been imported into AWS, and is available in the dropdown when "Key" is selected in the RightScale dashboard.

![Gitosis Private Key Input Screenshot](http://farm6.static.flickr.com/12345/5411803592_2f13c80854_o.png)
* Postfix MySQL Database Password

  Pick a secure password for the user account that postfix will use to access the MySQL database.  Did I mention that Postfix configuration information is stored in MySQL?  I promise, I'll explain later.
* EBS Volume Size in GB

  This server stores all of the data which needs to be persistent on a separate EBS volume to ease backups, disaster recovery, and vertical scaling.  Specify an EBS volume size here that makes sense for the data you're storing, including git repositories, MySQL databases and your web site/application html and code files.

If you're in a hurry, and just wanted to get this up and running quickly, that's all you'll need to know.

## Disaster Recovery or Vertical Scaling ##
As mentioned, all of the configuration and application data for all the services is stored on an EBS volume.  That EBS volume has a snapshot taken of it once per day.  Those snapshots can be used to start a new instance of this server with the data and configuration exactly as it was at that point in time.

This is useful for vertical scaling.  I.E. Using a bigger, badder EC2 instance type to manage more traffic.  It's also useful for disaster recovery.

To bring up a new instance from a snapshot, these are the steps.

1. Find the AWS ID of the latest snapshot for your data volume
  * Alternate first step is to create a snapshot "right now" by running the "rjg_utils::aio_ebs_volume_snapshot" recipe on the current instance.
2. Add a new server to your deployment using this ServerTemplate
3. Click "Launch" and set all of your inputs to the desired values
4. For the "EBS Volume Snapshot Id", replace the value "blank" with the AWS ID of the snapshot you acquired in step 1
5. Launch the new instance
6. Run the "web_apache::enable_site_vhost" or "app_wordpress::deploy" (which ever is appropriate) once for each vhosted domain this server answers for.
7. Verify web and email vhosts are working properly (change /etc/hosts file to point to new IP etc)
8. Change your DNS records from the IP of the old instance, to the new one
  * **Pro Tip**: Or, if you're using an Elastic IP, just reassign the the EIP to the new instance
9. Once DNS records are propagated, or EIP remap is finished, decommission old instance
10. Clean up EBS volume and snapshots of old instance
  * See "Managing Artifacts" below

# Configuring Services #

## Wordpress Powered Website ##
If you want to host a Wordpress powered website, you're only a few inputs and clicks away

Inputs
1. MySQL Database Password for this Wordpress instance
  Pick a secure password which Wordpress will use to access the database.  The Wordpress configuration file will automatically be created with this information
2. VHOST Aliases
  The possible hostname aliases (if any) for the vhost.  For instance to host the same content at www.yourdomain.com and yourdomain.com simply put "yourdomain.com" here.  Many values can be supplied, separated by spaces.  If you don't want any aliases leave the text "blank" in this field.  "blank" is a magic word that is used to work around some issues in the current version of RightLink
3. VHOST FQDN
  The fully qualified domain name (FQDN) of the new vhost to create.  Example www.apache.org

## Website ##
If you want to host a website that's just static HTML, or a mix of HTML and some PHP files, you can set it up by running the "web_apache::enable_site_vhost" script.

This script takes only two inputs.
1. VHOST Aliases
  The possible hostname aliases (if any) for the vhost.  For instance to host the same content at www.yourdomain.com and yourdomain.com simply put "yourdomain.com" here.  Many values can be supplied, separated by spaces.  If you don't want any aliases leave the text "blank" in this field.  "blank" is a magic word that is used to work around some issues in the current version of RightLink
2. VHOST FQDN
  The fully qualified domain name (FQDN) of the new vhost to create.  Example www.apache.org

Running the script will create the necessary configuration file(s) for Apache2.  The root directory for the new website will be /mnt/www/&lt;VHOST FQDN&gt;/htdocs.  Put the your web files there and you're all set!

## Postfix Email Relaying ##
The configuration for postfix is stored in a MySQL database, thus the input attributes for a postfix MySQL user, database, and password.  Right now, you'll need to get right into the MySQL commandline in order to manipulate the configuration but there are plans to make this much more user friendly in the future.

### Virtual Domains ###
The first thing you'll need to do is tell postfix which domain names it'll be handling email for.

When connected to the server with SSH, type `mysql` to get into a mysql commandline client.  Then type `use postfix;` to select the postfix configuration database.  If you supplied a different database name for the postfix configuration, substitute that in the use command.  Then, for each domain you want to handle email for, run the following MySQL query.

_INSERT INTO transport (domain,destination) VALUES ('yourdomain.com','virtual:')_

Where 'yourdomain.com' is the domain name you want to handle email for.

### Virtual User Aliases ###
Once you've defined the domain names that you'll be handling email for, you'll want to setup which email addresses you'll be accepting email for, and what email address to relay them to.

When connected to the server with SSH, type `mysql` to get into a mysql commandline client.  Then type `use postfix;` to select the postfix configuration database.  If you supplied a different database name for the postfix configuration, substitute that in the use command.  Then, for each email address you want to accept email for, run the following MySQL query.

_INSERT INTO virtual (email,destination) VALUES ('you@yourdomain.com','you@gmail.com')_

The first value is the email address which your server will accept email for.  The 'yourdomain.com' must already be in transport table, which you would have added in the "Virtual Domains" section above.

The second value is the email address you want any emails sent to the 'you@yourdomain.com' relayed to.  It's just that easy!

You can specify many different email addresses to be relayed to the same destination address.  You can also specify a "catchall" destination for a domain by excluding the user.  I.E. Supplying '@yourdomain.com' for the first value, and 'you@gmail.com' as the second value would route any email sent to any address @yourdomain.com to your gmail address.  It's not advisable, but it can be done.

## Gitosis ##

# Managing Artifacts #
We've mentioned a couple times above that this server uses an EBS volume to store configuration and application data.  The creation of that EBS volume, and the creation of the snapshots for backups is fully automated.  The number of EBS snapshots for the current instance is even kept in check by the "aio_ebs_snapshots_to_keep" attribute.

However, when you launch a new instance to replace an existing one, some EBS artifacts get left behind which will need to be manually cleaned up.  Below you'll find information on what things to look out for.  Automating this cleanup is VERY high on my priority list for enhancements of this ServerTemplate.

## EBS Volumes ##
When you terminate a running instance of this server template, the automatically created EBS volume is not deleted.  So after performing the steps from the "Disaster Recovery or Vertical Scaling" section above, you'll want to look at the EBS volumes in the same region as the terminated instance, and go ahead and delete it.

You may want to verify that you have a current snapshot of the volume first, though you would probably have already done that before launching a new instance and terminating the old one.

## EBS Snapshots ##
Snapshots of the old EBS volume associated with a terminated instance are not automatically deleted by the backup script based on the "aio_ebs_snapshots_to_keep" attribute.  This is because the snapshots are not associated with the new volume or instance, so the script has no way of knowing that they are related.

As a result, you'll want to delete old snapshots which belong to terminated instances and/or deleted EBS volumes.

# TODO #
* Setup a default vhost
  * Including an SSL vhost that hosts various tools like phpmyadmin and a management tool for email configuration etc.
* More alerts
  * Postfix high load
  * Postfix not running
  * MySQL high load
  * MySQL not running
  * Low memory
  * Low disk space on AIO EBS
  * Apache high load
  * Apache not running
* Deployment/management recipes for Zend Framework apps
* Enable gitweb (probably within aforementioned SSL vhost)
* Installation/Deployment/management recipes for Drupal? Maybe?
* Consider swapping apache2 for nginx
* Full and proper email stack (local delivery, pop3, imap, ldap configuration)</description>
    <name>Web (LAMP) &amp; Email (Postfix) vhost AIO - BETA Rev1</name>
    <created_at>2011/02/03 21:09:10 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>1</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes>* Fixed AWS-S3 Errors &amp; Poor Reporting
* Fixed rewrite log file name
* Fixed document root &amp; system/maintenance.html paths.</revision_notes>
    <updated_at>2011/02/11 20:27:46 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>ServerTemplate</content_type>
    <commit_message>
      <text>* Fixed AWS-S3 Errors &amp; Poor Reporting
* Fixed rewrite log file name
* Fixed document root &amp; system/maintenance.html paths.</text>
      <time>2011/02/11 20:26:04 +0000</time>
      <user>me@ryangeyer.com</user>
    </commit_message>
    <description>A reverse proxy server configured using Apache2.  This is intended to overcome the issue of having only a single assignable IP address for any EC2 instance.  Setting one of these server instances up allows you to use the IP address assigned to it to forward traffic to a single backend box which may be running many SSL sites on different ports.

Effectively, you're paying $6.11(reserved) or $15.60(on-demand) per month for an additional IP address.  This makes the most sense if you're running a single (big) windows instance to back many of these proxies, which coincidentally is exactly the way that we're using it.

FAQ
---
* Why not use nginx?
  I probably will in the future since it's a bit more conservative about memory and CPU use, but I needed to create this reasonably quickly and get it working in our environment.  I was comfortable with Apache2 and knew it could do the job, so it was the easy choice for rapid deployment.
* What's up with the "Alpha" designation?
  This ServerTemplate uses Chef, which is still in beta on the RightScale management platform, plus this is the first revision of the ServerTemplate to be published.  That said, this ServerTemplate is in use in production in our environment, and has been tested pretty thoroughly.  Feel free to let me know if you have any problems with this!
* How come no load balancing?
  There are other ServerTemplates for that, and our use case doesn't necessitate load balancing.

ToDo
----
* Add support for a maintenance page/mode
* Add support for a (god forbid) outage page/mode</description>
    <name>Apache2 SSL Reverse Proxy - Alpha1</name>
    <created_at>2011/02/11 20:27:45 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>2</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2011/04/13 17:20:16 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>CookbookRepoSequence</content_type>
    <commit_message>
      <text>Committing for release of Nginx Reverse Proxy.  All repos are branched with "release_20110401" for this commit.</text>
      <time>2011/04/01 22:45:40 +0000</time>
      <user>me@ryangeyer.com</user>
    </commit_message>
    <description></description>
    <name>Linux RightLink 5.6 Compatible</name>
    <created_at>2011/04/13 17:20:15 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>6</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes>Initial Commit</revision_notes>
    <updated_at>2011/04/13 17:20:16 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>ServerTemplate</content_type>
    <commit_message>
      <text>Initial Commit</text>
      <time>2011/04/13 17:19:29 +0000</time>
      <user>me@ryangeyer.com</user>
    </commit_message>
    <description>This is the natural evolution of my [Apache2 Reverse Proxy ServerTemplate](http://www.rightscale.com/library/server_templates/Apache2-SSL-Reverse-Proxy-Alph/12345)

A reverse proxy server configured using Nginx.  This is intended to overcome the issue of having only a single assignable IP address for any EC2 instance.  Setting one of these server instances up allows you to use the IP address assigned to it to forward traffic to a single backend box which may be running many SSL sites on different ports.

Effectively, you're paying $6.11(reserved) or $15.60(on-demand) per month for an additional IP address.  This makes the most sense if you're running a single (big) windows instance to back many of these proxies, which coincidentally is exactly the way that we're using it.

FAQ
---
* What's up with the "Alpha" designation?
  This ServerTemplate uses Chef, which is still in beta on the RightScale management platform, plus this is the first revision of the ServerTemplate to be published.  That said, this ServerTemplate is in use in production in our environment, and has been tested pretty thoroughly.  Feel free to let me know if you have any problems with this!
* How come no load balancing?
  There are other ServerTemplates for that, and our use case doesn't necessitate load balancing.

ToDo
----
* Add support for a maintenance page/mode
* Add support for a (god forbid) outage page/mode</description>
    <name>Nginx SSL Reverse Proxy - Alpha1</name>
    <created_at>2011/04/13 17:20:15 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>1</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes>Updated to MCI with RL 5.6.28</revision_notes>
    <updated_at>2011/04/13 17:31:22 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>ServerTemplate</content_type>
    <commit_message>
      <text>Updated to MCI with RL 5.6.28</text>
      <time>2011/04/13 17:30:53 +0000</time>
      <user>me@ryangeyer.com</user>
    </commit_message>
    <description>This is the natural evolution of my [Apache2 Reverse Proxy ServerTemplate](http://www.rightscale.com/library/server_templates/Apache2-SSL-Reverse-Proxy-Alph/12345)

A reverse proxy server configured using Nginx.  This is intended to overcome the issue of having only a single assignable IP address for any EC2 instance.  Setting one of these server instances up allows you to use the IP address assigned to it to forward traffic to a single backend box which may be running many SSL sites on different ports.

Effectively, you're paying $6.11(reserved) or $15.60(on-demand) per month for an additional IP address.  This makes the most sense if you're running a single (big) windows instance to back many of these proxies, which coincidentally is exactly the way that we're using it.

FAQ
---
* What's up with the "Alpha" designation?
  This ServerTemplate uses Chef, which is still in beta on the RightScale management platform, plus this is the first revision of the ServerTemplate to be published.  That said, this ServerTemplate is in use in production in our environment, and has been tested pretty thoroughly.  Feel free to let me know if you have any problems with this!
* How come no load balancing?
  There are other ServerTemplates for that, and our use case doesn't necessitate load balancing.

ToDo
----
* Add support for a maintenance page/mode
* Add support for a (god forbid) outage page/mode</description>
    <name>Nginx SSL Reverse Proxy - Alpha1</name>
    <created_at>2011/04/13 17:31:22 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>2</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2011/05/07 02:24:12 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>CookbookRepoSequence</content_type>
    <commit_message>
      <text>Updated nginx in github.com/rgeyer/cookbooks_rs.git to support reverse proxying without SSL</text>
      <time>2011/05/07 02:07:03 +0000</time>
      <user>me@ryangeyer.com</user>
    </commit_message>
    <description></description>
    <name>Linux RightLink 5.6 Compatible</name>
    <created_at>2011/05/07 02:24:11 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>7</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes>Now supports an HTTP only configuration by setting "Proxy for HTTPS?" to false</revision_notes>
    <updated_at>2011/05/07 02:24:12 +0000</updated_at>
    <publisher>Mentor Solutions Application Team - Ryan Geyer</publisher>
    <content_type>ServerTemplate</content_type>
    <commit_message>
      <text>Now supports an HTTP only configuration by setting "Proxy for HTTPS?" to false</text>
      <time>2011/05/07 02:13:55 +0000</time>
      <user>me@ryangeyer.com</user>
    </commit_message>
    <description>This is the natural evolution of my [Apache2 Reverse Proxy ServerTemplate](http://www.rightscale.com/library/server_templates/Apache2-SSL-Reverse-Proxy-Alph/12345)

A reverse proxy server configured using Nginx.  This is intended to overcome the issue of having only a single assignable IP address for any EC2 instance.  Setting one of these server instances up allows you to use the IP address assigned to it to forward traffic to a single backend box which may be running many SSL sites on different ports.

Effectively, you're paying $5.91(reserved) or $15.40(on-demand) per month for an additional IP address.  This makes the most sense if you're running a single (big) windows instance to back many of these proxies, which coincidentally is exactly the way that we're using it.

FAQ
---
* What's up with the "Beta" designation?
  This ServerTemplate uses Chef, which is still in beta on the RightScale management platform, plus this is the first revision of the ServerTemplate to be published.  That said, this ServerTemplate is in use in production in our environment, and has been tested pretty thoroughly.  Feel free to let me know if you have any problems with this!
* How come no load balancing?
  There are other ServerTemplates for that, and our use case doesn't necessitate load balancing.

ToDo
----
* Add support for a maintenance page/mode
* Add support for a (god forbid) outage page/mode

Release Notes
------------
* Rev 3
  * Now supports an HTTP only configuration by setting "Proxy for HTTPS?" to false</description>
    <name>Nginx HTTP(S) Reverse Proxy - Beta</name>
    <created_at>2011/05/07 02:24:12 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>3</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2011/05/19 19:36:26 +0000</updated_at>
    <publisher>Ryan Geyer</publisher>
    <content_type>RightScript</content_type>
    <commit_message>
      <text>Initial Commit, allow null inputs</text>
      <time>2011/05/17 05:15:03 +0000</time>
      <user>me@ryangeyer.com</user>
    </commit_message>
    <description></description>
    <name>[OpsCode] Delete Node</name>
    <created_at>2011/05/17 05:47:04 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>1</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2011/05/19 19:36:26 +0000</updated_at>
    <publisher>Ryan Geyer</publisher>
    <content_type>RightScript</content_type>
    <commit_message>
      <text>Initial Commit, allow null inputs</text>
      <time>2011/05/17 05:14:53 +0000</time>
      <user>me@ryangeyer.com</user>
    </commit_message>
    <description></description>
    <name>[OpsCode] Chef Run</name>
    <created_at>2011/05/17 05:47:04 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>1</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2011/05/19 19:36:27 +0000</updated_at>
    <publisher>Ryan Geyer</publisher>
    <content_type>RightScript</content_type>
    <commit_message>
      <text>Initial Commit, allow null inputs</text>
      <time>2011/05/17 05:14:46 +0000</time>
      <user>me@ryangeyer.com</user>
    </commit_message>
    <description></description>
    <name>[OpsCode] Initial Chef Run</name>
    <created_at>2011/05/17 05:47:05 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>1</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2011/05/19 19:36:27 +0000</updated_at>
    <publisher>Ryan Geyer</publisher>
    <content_type>RightScript</content_type>
    <commit_message>
      <text>Added lumberjack and sketchy hosts along with UUID to node attributes.  Done tweaking for a while</text>
      <time>2011/05/18 16:59:16 +0000</time>
      <user>me@ryangeyer.com</user>
    </commit_message>
    <description></description>
    <name>[OpsCode] Connect Node</name>
    <created_at>2011/05/18 17:00:03 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>3</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2011/05/19 19:36:27 +0000</updated_at>
    <publisher>Ryan Geyer</publisher>
    <content_type>CookbookRepoSequence</content_type>
    <commit_message>
      <text>AIO Rev2 - Release 20110519</text>
      <time>2011/05/19 17:50:03 +0000</time>
      <user>me@ryangeyer.com</user>
    </commit_message>
    <description></description>
    <name>Web &amp; Email vhost AIO</name>
    <created_at>2011/05/19 19:36:24 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>3</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes>Rev2: LAMP -&gt; LNMP, Dropped Gitosis &amp; Zend</revision_notes>
    <updated_at>2011/12/08 18:19:21 +0000</updated_at>
    <publisher>Ryan Geyer</publisher>
    <content_type>ServerTemplate</content_type>
    <commit_message>
      <text>Rev2: LAMP -&gt; LNMP, Dropped Gitosis &amp; Zend</text>
      <time>2011/05/19 18:04:24 +0000</time>
      <user>me@ryangeyer.com</user>
    </commit_message>
    <description># Description #
This is an All-In-One (AIO) server for hosting PHP based web sites/applications, as well as email for one or many domain names (virtual hosting).

## Total Cost of Ownership ##
This ServerTemplate is designed to run within the confines of a [t1.micro](http://aws.amazon.com/ec2/instance-types/) EC2 instance.  A t1.micro instance requires that you use an EBS volume to store the operating system.  The MultiCloud Image this ServerTemplate uses automatically creates an 8GB EBS volume for this purpose.

This server template requires one additional EBS volume for storing configuration and application data, the size of which will vary based on what you're running.  The default size for this partition is 2GB.  Combined with the 8GB root partition the total EBS footprint is exactly 10GB, the maximum for the AWS free tier.

When you first sign up for AWS you can take advantage of their [free tier](http://aws.amazon.com/free/) for all services for one year.

While using this server template I've averaged $0.12 per month between EIP data transfer costs, and the additional EBS volume.

After one year when the free tier expires, you can expect to spend under $15 per month if you pay for a t1.micro reserved instance, broken down thusly.

* t1.micro reservation for 1 year $54 ($4.50/mo but billed once at the beginning)
* 730hr t1.micro usage @$0.007/hr (Reserved cost in US-EAST cloud) $5.11/mo
* 8GB EBS Volume $0.80/mo
* 2GB EBS Volume $0.20/mo
* 14GB EBS Snapshot Storage (The 2GB configuration/application data volume, full, with 7 days of history, which is the default) $2.10/mo

That totals out to $12.71/mo, which leaves $2.29 for data transfer, I/O requests and maybe some S3 storage.

As I personally run this more, I'll be able to give some more real world data, rather than just estimates.  The point though, is that this is dirt cheap given the control you have!

## LNMP Virtual Hosting ##
The web hosting environment is a full LNMP stack consisting of;

* Linux - Ubuntu 10.04
* Nginx - 1.0.2
* MySQL - 5.1.41-3 (Ubuntu 12.10)
* PHP - 5.3.3-1 (Ubuntu 9.3)

## Email Virtual Hosting ##
In addition to the LNMP stack, a Postfix server is installed and configured for virtual hosting of one or many email domains.  Currently, the postfix server is configured to relay email for configured email addresses (more information on that below) to one or more other email addresses.  I use this to accept email for a domain, and effectively "forward" it to my gmail account where I manage all of my email.

# Usage #

## Prerequisites ##

### Elastic IP ###
It is *HIGHLY* recommended that you setup an Elastic IP for your server instance.  This will make things like vertical scaling and disaster recovery easier.

Also, if you're going to be serious about running an email server, using an EIP is the only way to go so you don't get blacklisted etc.  Setup an EIP, then make sure you fill out [this form](https://aws-portal.amazon.com/gp/aws/html-forms-controller/contactus/ec2-email-limit-rdns-request) to setup a reverse DNS record for your hostname (like mail.yourdomain.com) to your EIP.  You can read about why this is important [here](http://www.simpledns.com/kb.aspx?kbid=1052)

### Security Groups ###
You'll need to be able to communicate with your server from the interwebs.  This means you'll need to open some ports in one or more security groups, and add your server instance to those security groups.

As a best practice, try to avoid making all of your changes to the "default" security group.  It's also better if you put the ports for each service in it's own security group, though just one security group which opens all ports for this server instance is probably okay too.  Here are the ports that are required to be able to communicate with this server.

* SSH - TCP:22
* SMTP - TCP:25
* HTTP - TCP:80
* HTTPS - TCP:443

## Launching for the first time ##
If you've just imported this ServerTemplate from the library, here's what you need to know to get started.

### Inputs ###
* Database Admin Password

  Pick a secure password for the database administrator.  The default administrator username is "administrator".  It's possible that you'll never need to use these credentials since the Chef recipes set everything up for you, but it's good to have in case of emergency or for administrative tasks not covered in an operational script etc.

* Postfix MySQL Database Password

  Pick a secure password for the user account that postfix will use to access the MySQL database.  Did I mention that Postfix configuration information is stored in MySQL?  I promise, I'll explain later.
* EBS Volume Size in GB

  This server stores all of the data which needs to be persistent on a separate EBS volume to ease backups, disaster recovery, and vertical scaling.  Specify an EBS volume size here that makes sense for the data you're storing, including git repositories, MySQL databases and your web site/application html and code files.  **NOTE**: The default is 2GB

If you're in a hurry, and just wanted to get this up and running quickly, that's all you'll need to know.

## Disaster Recovery or Vertical Scaling ##
As mentioned, all of the configuration and application data for all the services is stored on an EBS volume.  That EBS volume has a snapshot taken of it once per day.  Those snapshots can be used to start a new instance of this server with the data and configuration exactly as it was at that point in time.

This is useful for vertical scaling.  I.E. Using a bigger, badder EC2 instance type to manage more traffic.  It's also useful for disaster recovery.

To bring up a new instance from a snapshot, these are the steps.

1. Find the AWS ID of the latest snapshot for your data volume
  * Alternate first step is to create a snapshot "right now" by running the "rjg_utils::aio_ebs_volume_snapshot" recipe on the current instance.
2. Add a new server to your deployment using this ServerTemplate
3. Click "Launch" and set all of your inputs to the desired values
4. For the "EBS Volume Snapshot Id", replace the value "blank" with the AWS ID of the snapshot you acquired in step 1
5. Launch the new instance
6. Run the "web_apache::enable_site_vhost" or "app_wordpress::deploy" (which ever is appropriate) once for each vhosted domain this server answers for.
7. Verify web and email vhosts are working properly (change /etc/hosts file to point to new IP etc)
8. Change your DNS records from the IP of the old instance, to the new one
  * **Pro Tip**: Or, if you're using an Elastic IP, just reassign the the EIP to the new instance
9. Once DNS records are propagated, or EIP remap is finished, decommission old instance
10. Clean up EBS volume and snapshots of old instance
  * See "Managing Artifacts" below

# Configuring Services #

## Wordpress Powered Website ##
If you want to host a Wordpress powered website, you're only a few inputs and clicks away

Inputs
1. MySQL Database Password for this Wordpress instance
  Pick a secure password which Wordpress will use to access the database.  The Wordpress configuration file will automatically be created with this information
2. VHOST Aliases
  The possible hostname aliases (if any) for the vhost.  For instance to host the same content at www.yourdomain.com and yourdomain.com simply put "yourdomain.com" here.  Many values can be supplied, separated by spaces.  If you don't want any aliases leave the text "blank" in this field.  "blank" is a magic word that is used to work around some issues in the current version of RightLink
3. VHOST FQDN
  The fully qualified domain name (FQDN) of the new vhost to create.  Example www.apache.org

## Website ##
If you want to host a website that's just static HTML, or a mix of HTML and some PHP files, you can set it up by running the "web_apache::enable_site_vhost" script.

This script takes only two inputs.
1. VHOST Aliases
  The possible hostname aliases (if any) for the vhost.  For instance to host the same content at www.yourdomain.com and yourdomain.com simply put "yourdomain.com" here.  Many values can be supplied, separated by spaces.  If you don't want any aliases leave the text "blank" in this field.  "blank" is a magic word that is used to work around some issues in the current version of RightLink
2. VHOST FQDN
  The fully qualified domain name (FQDN) of the new vhost to create.  Example www.apache.org

Running the script will create the necessary configuration file(s) for Apache2.  The root directory for the new website will be /mnt/www/&lt;VHOST FQDN&gt;/htdocs.  Put the your web files there and you're all set!

## Postfix Email Relaying ##
The configuration for postfix is stored in a MySQL database, thus the input attributes for a postfix MySQL user, database, and password.  Right now, you'll need to get right into the MySQL commandline in order to manipulate the configuration but there are plans to make this much more user friendly in the future.

### Virtual Domains ###
The first thing you'll need to do is tell postfix which domain names it'll be handling email for.

When connected to the server with SSH, type `mysql` to get into a mysql commandline client.  Then type `use postfix;` to select the postfix configuration database.  If you supplied a different database name for the postfix configuration, substitute that in the use command.  Then, for each domain you want to handle email for, run the following MySQL query.

_INSERT INTO transport (domain,destination) VALUES ('yourdomain.com','virtual:')_

Where 'yourdomain.com' is the domain name you want to handle email for.

### Virtual User Aliases ###
Once you've defined the domain names that you'll be handling email for, you'll want to setup which email addresses you'll be accepting email for, and what email address to relay them to.

When connected to the server with SSH, type `mysql` to get into a mysql commandline client.  Then type `use postfix;` to select the postfix configuration database.  If you supplied a different database name for the postfix configuration, substitute that in the use command.  Then, for each email address you want to accept email for, run the following MySQL query.

_INSERT INTO virtual (email,destination) VALUES ('you@yourdomain.com','you@gmail.com')_

The first value is the email address which your server will accept email for.  The 'yourdomain.com' must already be in transport table, which you would have added in the "Virtual Domains" section above.

The second value is the email address you want any emails sent to the 'you@yourdomain.com' relayed to.  It's just that easy!

You can specify many different email addresses to be relayed to the same destination address.  You can also specify a "catchall" destination for a domain by excluding the user.  I.E. Supplying '@yourdomain.com' for the first value, and 'you@gmail.com' as the second value would route any email sent to any address @yourdomain.com to your gmail address.  It's not advisable, but it can be done.

# Managing Artifacts #
We've mentioned a couple times above that this server uses an EBS volume to store configuration and application data.  The creation of that EBS volume, and the creation of the snapshots for backups is fully automated.  The number of EBS snapshots for the current instance is even kept in check by the "aio_ebs_snapshots_to_keep" attribute.

However, when you launch a new instance to replace an existing one, some EBS artifacts get left behind which will need to be manually cleaned up.  Below you'll find information on what things to look out for.  Automating this cleanup is VERY high on my priority list for enhancements of this ServerTemplate.

## EBS Volumes ##
When you terminate a running instance of this server template, the automatically created EBS volume is not deleted.  So after performing the steps from the "Disaster Recovery or Vertical Scaling" section above, you'll want to look at the EBS volumes in the same region as the terminated instance, and go ahead and delete it.

You may want to verify that you have a current snapshot of the volume first, though you would probably have already done that before launching a new instance and terminating the old one.

## EBS Snapshots ##
Snapshots of the old EBS volume associated with a terminated instance are not automatically deleted by the backup script based on the "aio_ebs_snapshots_to_keep" attribute.  This is because the snapshots are not associated with the new volume or instance, so the script has no way of knowing that they are related.

As a result, you'll want to delete old snapshots which belong to terminated instances and/or deleted EBS volumes.

# Change Log #
* Rev 1
  * Initial release
* Rev 2
  * Replaced Apache with Nginx
  * Running PHP5 FPM application server rather than a PHP module for Apache or Nginx
  * Dropped incomplete support for Zend Framework
  * Dropped Gitosis as a default, since I imagine I'm the only person using it, and it's a bit out of place
  * Added Alerts for critical systems and failure/limp conditions
  * New MCI which includes RightLink 5.6.28 and creates an 8GB root partition rather than 10GB
  * Added ability to connect this server with the [Opscode](http://www.opscode.com/platform/) Chef platform to further customize your instance


# TODO #
* Setup a default vhost
  * Including an SSL vhost that hosts various tools like phpmyadmin and a management tool for email configuration etc.
* More alerts
  * Postfix high load
  * MySQL high load
  * Low memory
  * Nginx high load
* Reconsider ZendFramework support
* Enable gitweb (probably within aforementioned SSL vhost)
* Installation/Deployment/management recipes for Drupal? Maybe?
* Full and proper email stack (local delivery, pop3, imap, ldap configuration)</description>
    <name>LNMP &amp; Email Vhosting All-In-One with Nginx, PHP5-FPM, MySQL 5.1, and Postfix - Rev2</name>
    <created_at>2011/05/19 19:36:25 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>2</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2011/06/01 00:20:27 +0000</updated_at>
    <publisher>Ryan Geyer</publisher>
    <content_type>CookbookRepoSequence</content_type>
    <commit_message>
      <text>AIO Rev3 - Release 20110531

Fixes for app_wordpress</text>
      <time>2011/06/01 00:06:48 +0000</time>
      <user>me@ryangeyer.com</user>
    </commit_message>
    <description></description>
    <name>Web &amp; Email vhost AIO</name>
    <created_at>2011/06/01 00:20:25 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>4</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes>Rev3 - Fixed app_wordpress::update, special characters now allowed in MySQL passwords</revision_notes>
    <updated_at>2011/12/08 18:19:32 +0000</updated_at>
    <publisher>Ryan Geyer</publisher>
    <content_type>ServerTemplate</content_type>
    <commit_message>
      <text>Rev3 - Fixed app_wordpress::update, special characters now allowed in MySQL passwords</text>
      <time>2011/06/01 00:18:54 +0000</time>
      <user>me@ryangeyer.com</user>
    </commit_message>
    <description># Description #
This is an All-In-One (AIO) server for hosting PHP based web sites/applications, as well as email for one or many domain names (virtual hosting).

## Total Cost of Ownership ##
This ServerTemplate is designed to run within the confines of a [t1.micro](http://aws.amazon.com/ec2/instance-types/) EC2 instance.  A t1.micro instance requires that you use an EBS volume to store the operating system.  The MultiCloud Image this ServerTemplate uses automatically creates an 8GB EBS volume for this purpose.

This server template requires one additional EBS volume for storing configuration and application data, the size of which will vary based on what you're running.  The default size for this partition is 2GB.  Combined with the 8GB root partition the total EBS footprint is exactly 10GB, the maximum for the AWS free tier.

When you first sign up for AWS you can take advantage of their [free tier](http://aws.amazon.com/free/) for all services for one year.

While using this server template I've averaged $0.12 per month between EIP data transfer costs, and the additional EBS volume.

After one year when the free tier expires, you can expect to spend under $15 per month if you pay for a t1.micro reserved instance, broken down thusly.

* t1.micro reservation for 1 year $54 ($4.50/mo but billed once at the beginning)
* 730hr t1.micro usage @$0.007/hr (Reserved cost in US-EAST cloud) $5.11/mo
* 8GB EBS Volume $0.80/mo
* 2GB EBS Volume $0.20/mo
* 14GB EBS Snapshot Storage (The 2GB configuration/application data volume, full, with 7 days of history, which is the default) $2.10/mo

That totals out to $12.71/mo, which leaves $2.29 for data transfer, I/O requests and maybe some S3 storage.

As I personally run this more, I'll be able to give some more real world data, rather than just estimates.  The point though, is that this is dirt cheap given the control you have!

## LNMP Virtual Hosting ##
The web hosting environment is a full LNMP stack consisting of;

* Linux - Ubuntu 10.04
* Nginx - 1.0.2
* MySQL - 5.1.41-3 (Ubuntu 12.10)
* PHP - 5.3.3-1 (Ubuntu 9.3)

## Email Virtual Hosting ##
In addition to the LNMP stack, a Postfix server is installed and configured for virtual hosting of one or many email domains.  Currently, the postfix server is configured to relay email for configured email addresses (more information on that below) to one or more other email addresses.  I use this to accept email for a domain, and effectively "forward" it to my gmail account where I manage all of my email.

# Usage #

## Prerequisites ##

### Elastic IP ###
It is *HIGHLY* recommended that you setup an Elastic IP for your server instance.  This will make things like vertical scaling and disaster recovery easier.

Also, if you're going to be serious about running an email server, using an EIP is the only way to go so you don't get blacklisted etc.  Setup an EIP, then make sure you fill out [this form](https://aws-portal.amazon.com/gp/aws/html-forms-controller/contactus/ec2-email-limit-rdns-request) to setup a reverse DNS record for your hostname (like mail.yourdomain.com) to your EIP.  You can read about why this is important [here](http://www.simpledns.com/kb.aspx?kbid=1052)

### Security Groups ###
You'll need to be able to communicate with your server from the interwebs.  This means you'll need to open some ports in one or more security groups, and add your server instance to those security groups.

As a best practice, try to avoid making all of your changes to the "default" security group.  It's also better if you put the ports for each service in it's own security group, though just one security group which opens all ports for this server instance is probably okay too.  Here are the ports that are required to be able to communicate with this server.

* SSH - TCP:22
* SMTP - TCP:25
* HTTP - TCP:80
* HTTPS - TCP:443

## Launching for the first time ##
If you've just imported this ServerTemplate from the library, here's what you need to know to get started.

### Inputs ###
* Database Admin Password

  Pick a secure password for the database administrator.  The default administrator username is "administrator".  It's possible that you'll never need to use these credentials since the Chef recipes set everything up for you, but it's good to have in case of emergency or for administrative tasks not covered in an operational script etc.

* Postfix MySQL Database Password

  Pick a secure password for the user account that postfix will use to access the MySQL database.  Did I mention that Postfix configuration information is stored in MySQL?  I promise, I'll explain later.
* EBS Volume Size in GB

  This server stores all of the data which needs to be persistent on a separate EBS volume to ease backups, disaster recovery, and vertical scaling.  Specify an EBS volume size here that makes sense for the data you're storing, including git repositories, MySQL databases and your web site/application html and code files.  **NOTE**: The default is 2GB

If you're in a hurry, and just wanted to get this up and running quickly, that's all you'll need to know.

## Disaster Recovery or Vertical Scaling ##
As mentioned, all of the configuration and application data for all the services is stored on an EBS volume.  That EBS volume has a snapshot taken of it once per day.  Those snapshots can be used to start a new instance of this server with the data and configuration exactly as it was at that point in time.

This is useful for vertical scaling.  I.E. Using a bigger, badder EC2 instance type to manage more traffic.  It's also useful for disaster recovery.

To bring up a new instance from a snapshot, these are the steps.

1. Find the AWS ID of the latest snapshot for your data volume
  * Alternate first step is to create a snapshot "right now" by running the "rjg_utils::aio_ebs_volume_snapshot" recipe on the current instance.
2. Add a new server to your deployment using this ServerTemplate
3. Click "Launch" and set all of your inputs to the desired values
4. For the "EBS Volume Snapshot Id", replace the value "blank" with the AWS ID of the snapshot you acquired in step 1
5. Launch the new instance
6. Run the "web_apache::enable_site_vhost" or "app_wordpress::deploy" (which ever is appropriate) once for each vhosted domain this server answers for.
7. Verify web and email vhosts are working properly (change /etc/hosts file to point to new IP etc)
8. Change your DNS records from the IP of the old instance, to the new one
  * **Pro Tip**: Or, if you're using an Elastic IP, just reassign the the EIP to the new instance
9. Once DNS records are propagated, or EIP remap is finished, decommission old instance
10. Clean up EBS volume and snapshots of old instance
  * See "Managing Artifacts" below

# Configuring Services #

## Wordpress Powered Website ##
If you want to host a Wordpress powered website, you're only a few inputs and clicks away

Inputs
1. MySQL Database Password for this Wordpress instance
  Pick a secure password which Wordpress will use to access the database.  The Wordpress configuration file will automatically be created with this information
2. VHOST Aliases
  The possible hostname aliases (if any) for the vhost.  For instance to host the same content at www.yourdomain.com and yourdomain.com simply put "yourdomain.com" here.  Many values can be supplied, separated by spaces.  If you don't want any aliases leave the text "blank" in this field.  "blank" is a magic word that is used to work around some issues in the current version of RightLink
3. VHOST FQDN
  The fully qualified domain name (FQDN) of the new vhost to create.  Example www.apache.org

## Website ##
If you want to host a website that's just static HTML, or a mix of HTML and some PHP files, you can set it up by running the "web_apache::enable_site_vhost" script.

This script takes only two inputs.
1. VHOST Aliases
  The possible hostname aliases (if any) for the vhost.  For instance to host the same content at www.yourdomain.com and yourdomain.com simply put "yourdomain.com" here.  Many values can be supplied, separated by spaces.  If you don't want any aliases leave the text "blank" in this field.  "blank" is a magic word that is used to work around some issues in the current version of RightLink
2. VHOST FQDN
  The fully qualified domain name (FQDN) of the new vhost to create.  Example www.apache.org

Running the script will create the necessary configuration file(s) for Apache2.  The root directory for the new website will be /mnt/www/&lt;VHOST FQDN&gt;/htdocs.  Put the your web files there and you're all set!

## Postfix Email Relaying ##
The configuration for postfix is stored in a MySQL database, thus the input attributes for a postfix MySQL user, database, and password.  Right now, you'll need to get right into the MySQL commandline in order to manipulate the configuration but there are plans to make this much more user friendly in the future.

### Virtual Domains ###
The first thing you'll need to do is tell postfix which domain names it'll be handling email for.

When connected to the server with SSH, type `mysql` to get into a mysql commandline client.  Then type `use postfix;` to select the postfix configuration database.  If you supplied a different database name for the postfix configuration, substitute that in the use command.  Then, for each domain you want to handle email for, run the following MySQL query.

_INSERT INTO transport (domain,destination) VALUES ('yourdomain.com','virtual:')_

Where 'yourdomain.com' is the domain name you want to handle email for.

### Virtual User Aliases ###
Once you've defined the domain names that you'll be handling email for, you'll want to setup which email addresses you'll be accepting email for, and what email address to relay them to.

When connected to the server with SSH, type `mysql` to get into a mysql commandline client.  Then type `use postfix;` to select the postfix configuration database.  If you supplied a different database name for the postfix configuration, substitute that in the use command.  Then, for each email address you want to accept email for, run the following MySQL query.

_INSERT INTO virtual (email,destination) VALUES ('you@yourdomain.com','you@gmail.com')_

The first value is the email address which your server will accept email for.  The 'yourdomain.com' must already be in transport table, which you would have added in the "Virtual Domains" section above.

The second value is the email address you want any emails sent to the 'you@yourdomain.com' relayed to.  It's just that easy!

You can specify many different email addresses to be relayed to the same destination address.  You can also specify a "catchall" destination for a domain by excluding the user.  I.E. Supplying '@yourdomain.com' for the first value, and 'you@gmail.com' as the second value would route any email sent to any address @yourdomain.com to your gmail address.  It's not advisable, but it can be done.

# Managing Artifacts #
We've mentioned a couple times above that this server uses an EBS volume to store configuration and application data.  The creation of that EBS volume, and the creation of the snapshots for backups is fully automated.  The number of EBS snapshots for the current instance is even kept in check by the "aio_ebs_snapshots_to_keep" attribute.

However, when you launch a new instance to replace an existing one, some EBS artifacts get left behind which will need to be manually cleaned up.  Below you'll find information on what things to look out for.  Automating this cleanup is VERY high on my priority list for enhancements of this ServerTemplate.

## EBS Volumes ##
When you terminate a running instance of this server template, the automatically created EBS volume is not deleted.  So after performing the steps from the "Disaster Recovery or Vertical Scaling" section above, you'll want to look at the EBS volumes in the same region as the terminated instance, and go ahead and delete it.

You may want to verify that you have a current snapshot of the volume first, though you would probably have already done that before launching a new instance and terminating the old one.

## EBS Snapshots ##
Snapshots of the old EBS volume associated with a terminated instance are not automatically deleted by the backup script based on the "aio_ebs_snapshots_to_keep" attribute.  This is because the snapshots are not associated with the new volume or instance, so the script has no way of knowing that they are related.

As a result, you'll want to delete old snapshots which belong to terminated instances and/or deleted EBS volumes.

# Change Log #
* Rev 1
  * Initial release
* Rev 2
  * Replaced Apache with Nginx
  * Running PHP5 FPM application server rather than a PHP module for Apache or Nginx
  * Dropped incomplete support for Zend Framework
  * Dropped Gitosis as a default, since I imagine I'm the only person using it, and it's a bit out of place
  * Added Alerts for critical systems and failure/limp conditions
  * New MCI which includes RightLink 5.6.28 and creates an 8GB root partition rather than 10GB
  * Added ability to connect this server with the [Opscode](http://www.opscode.com/platform/) Chef platform to further customize your instance


# TODO #
* Setup a default vhost
  * Including an SSL vhost that hosts various tools like phpmyadmin and a management tool for email configuration etc.
* More alerts
  * Postfix high load
  * MySQL high load
  * Low memory
  * Nginx high load
* Reconsider ZendFramework support
* Enable gitweb (probably within aforementioned SSL vhost)
* Installation/Deployment/management recipes for Drupal? Maybe?
* Full and proper email stack (local delivery, pop3, imap, ldap configuration)</description>
    <name>LNMP &amp; Email Vhosting All-In-One with Nginx, PHP5-FPM, MySQL 5.1, and Postfix - Rev3</name>
    <created_at>2011/06/01 00:20:26 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>3</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes>Initial Commit</revision_notes>
    <updated_at>2011/07/22 20:44:13 +0000</updated_at>
    <publisher>Ryan Geyer</publisher>
    <content_type>RightScript</content_type>
    <commit_message>
      <text>Initial Commit</text>
      <time>2011/07/22 19:12:41 +0000</time>
      <user>me@ryangeyer.com</user>
    </commit_message>
    <description>Removes the RightScale Rubygem mirrors from the list of sources for the gem executable both in the RightScale sandbox, and for the system ruby.</description>
    <name>SYS - Remove RightScale Rubygem mirrors</name>
    <created_at>2011/07/22 19:13:22 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>1</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes>Shebangs are nice</revision_notes>
    <updated_at>2011/07/22 20:43:56 +0000</updated_at>
    <publisher>Ryan Geyer</publisher>
    <content_type>RightScript</content_type>
    <commit_message>
      <text>Shebangs are nice</text>
      <time>2011/07/22 20:43:27 +0000</time>
      <user>me@ryangeyer.com</user>
    </commit_message>
    <description>Removes the RightScale Rubygem mirrors from the list of sources for the gem executable both in the RightScale sandbox, and for the system ruby.</description>
    <name>SYS - Remove RightScale Rubygem mirrors</name>
    <created_at>2011/07/22 20:43:56 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>2</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2011/12/08 18:18:04 +0000</updated_at>
    <publisher>Ryan Geyer</publisher>
    <content_type>CookbookRepoSequence</content_type>
    <commit_message>
      <text>Nginx update to fix a bug in the latest ubuntu package.</text>
      <time>2011/12/08 18:11:50 +0000</time>
      <user>ryan.geyer@rightscale.com</user>
    </commit_message>
    <description></description>
    <name>Web &amp; Email vhost AIO</name>
    <created_at>2011/12/08 18:18:02 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>5</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes>Rev 4</revision_notes>
    <updated_at>2011/12/08 18:19:12 +0000</updated_at>
    <publisher>Ryan Geyer</publisher>
    <content_type>ServerTemplate</content_type>
    <commit_message>
      <text>Rev 4</text>
      <time>2011/12/08 18:12:49 +0000</time>
      <user>ryan.geyer@rightscale.com</user>
    </commit_message>
    <description># Description #
This is an All-In-One (AIO) server for hosting PHP based web sites/applications, as well as email for one or many domain names (virtual hosting).

## Total Cost of Ownership ##
This ServerTemplate is designed to run within the confines of a [t1.micro](http://aws.amazon.com/ec2/instance-types/) EC2 instance.  A t1.micro instance requires that you use an EBS volume to store the operating system.  The MultiCloud Image this ServerTemplate uses automatically creates an 8GB EBS volume for this purpose.

This server template requires one additional EBS volume for storing configuration and application data, the size of which will vary based on what you're running.  The default size for this partition is 2GB.  Combined with the 8GB root partition the total EBS footprint is exactly 10GB, the maximum for the AWS free tier.

When you first sign up for AWS you can take advantage of their [free tier](http://aws.amazon.com/free/) for all services for one year.

While using this server template I've averaged $0.12 per month between EIP data transfer costs, and the additional EBS volume.

After one year when the free tier expires, you can expect to spend under $15 per month if you pay for a t1.micro reserved instance, broken down thusly.

* t1.micro reservation for 1 year $54 ($4.50/mo but billed once at the beginning)
* 730hr t1.micro usage @$0.007/hr (Reserved cost in US-EAST cloud) $5.11/mo
* 8GB EBS Volume $0.80/mo
* 2GB EBS Volume $0.20/mo
* 14GB EBS Snapshot Storage (The 2GB configuration/application data volume, full, with 7 days of history, which is the default) $2.10/mo

That totals out to $12.71/mo, which leaves $2.29 for data transfer, I/O requests and maybe some S3 storage.

As I personally run this more, I'll be able to give some more real world data, rather than just estimates.  The point though, is that this is dirt cheap given the control you have!

## LNMP Virtual Hosting ##
The web hosting environment is a full LNMP stack consisting of;

* Linux - Ubuntu 10.04
* Nginx - 1.0.2
* MySQL - 5.1.41-3 (Ubuntu 12.10)
* PHP - 5.3.3-1 (Ubuntu 9.3)

## Email Virtual Hosting ##
In addition to the LNMP stack, a Postfix server is installed and configured for virtual hosting of one or many email domains.  Currently, the postfix server is configured to relay email for configured email addresses (more information on that below) to one or more other email addresses.  I use this to accept email for a domain, and effectively "forward" it to my gmail account where I manage all of my email.

# Usage #

## Prerequisites ##

### Elastic IP ###
It is *HIGHLY* recommended that you setup an Elastic IP for your server instance.  This will make things like vertical scaling and disaster recovery easier.

Also, if you're going to be serious about running an email server, using an EIP is the only way to go so you don't get blacklisted etc.  Setup an EIP, then make sure you fill out [this form](https://aws-portal.amazon.com/gp/aws/html-forms-controller/contactus/ec2-email-limit-rdns-request) to setup a reverse DNS record for your hostname (like mail.yourdomain.com) to your EIP.  You can read about why this is important [here](http://www.simpledns.com/kb.aspx?kbid=1052)

### Security Groups ###
You'll need to be able to communicate with your server from the interwebs.  This means you'll need to open some ports in one or more security groups, and add your server instance to those security groups.

As a best practice, try to avoid making all of your changes to the "default" security group.  It's also better if you put the ports for each service in it's own security group, though just one security group which opens all ports for this server instance is probably okay too.  Here are the ports that are required to be able to communicate with this server.

* SSH - TCP:22
* SMTP - TCP:25
* HTTP - TCP:80
* HTTPS - TCP:443

## Launching for the first time ##
If you've just imported this ServerTemplate from the library, here's what you need to know to get started.

### Inputs ###
* Database Admin Password

  Pick a secure password for the database administrator.  The default administrator username is "administrator".  It's possible that you'll never need to use these credentials since the Chef recipes set everything up for you, but it's good to have in case of emergency or for administrative tasks not covered in an operational script etc.

* Postfix MySQL Database Password

  Pick a secure password for the user account that postfix will use to access the MySQL database.  Did I mention that Postfix configuration information is stored in MySQL?  I promise, I'll explain later.
* EBS Volume Size in GB

  This server stores all of the data which needs to be persistent on a separate EBS volume to ease backups, disaster recovery, and vertical scaling.  Specify an EBS volume size here that makes sense for the data you're storing, including git repositories, MySQL databases and your web site/application html and code files.  **NOTE**: The default is 2GB

If you're in a hurry, and just wanted to get this up and running quickly, that's all you'll need to know.

## Disaster Recovery or Vertical Scaling ##
As mentioned, all of the configuration and application data for all the services is stored on an EBS volume.  That EBS volume has a snapshot taken of it once per day.  Those snapshots can be used to start a new instance of this server with the data and configuration exactly as it was at that point in time.

This is useful for vertical scaling.  I.E. Using a bigger, badder EC2 instance type to manage more traffic.  It's also useful for disaster recovery.

To bring up a new instance from a snapshot, these are the steps.

1. Find the AWS ID of the latest snapshot for your data volume
  * Alternate first step is to create a snapshot "right now" by running the "rjg_utils::aio_ebs_volume_snapshot" recipe on the current instance.
2. Add a new server to your deployment using this ServerTemplate
3. Click "Launch" and set all of your inputs to the desired values
4. For the "EBS Volume Snapshot Id", replace the value "blank" with the AWS ID of the snapshot you acquired in step 1
5. Launch the new instance
6. Run the "web_apache::enable_site_vhost" or "app_wordpress::deploy" (which ever is appropriate) once for each vhosted domain this server answers for.
7. Verify web and email vhosts are working properly (change /etc/hosts file to point to new IP etc)
8. Change your DNS records from the IP of the old instance, to the new one
  * **Pro Tip**: Or, if you're using an Elastic IP, just reassign the the EIP to the new instance
9. Once DNS records are propagated, or EIP remap is finished, decommission old instance
10. Clean up EBS volume and snapshots of old instance
  * See "Managing Artifacts" below

# Configuring Services #

## Wordpress Powered Website ##
If you want to host a Wordpress powered website, you're only a few inputs and clicks away

Inputs
1. MySQL Database Password for this Wordpress instance
  Pick a secure password which Wordpress will use to access the database.  The Wordpress configuration file will automatically be created with this information
2. VHOST Aliases
  The possible hostname aliases (if any) for the vhost.  For instance to host the same content at www.yourdomain.com and yourdomain.com simply put "yourdomain.com" here.  Many values can be supplied, separated by spaces.  If you don't want any aliases leave the text "blank" in this field.  "blank" is a magic word that is used to work around some issues in the current version of RightLink
3. VHOST FQDN
  The fully qualified domain name (FQDN) of the new vhost to create.  Example www.apache.org

## Website ##
If you want to host a website that's just static HTML, or a mix of HTML and some PHP files, you can set it up by running the "web_apache::enable_site_vhost" script.

This script takes only two inputs.
1. VHOST Aliases
  The possible hostname aliases (if any) for the vhost.  For instance to host the same content at www.yourdomain.com and yourdomain.com simply put "yourdomain.com" here.  Many values can be supplied, separated by spaces.  If you don't want any aliases leave the text "blank" in this field.  "blank" is a magic word that is used to work around some issues in the current version of RightLink
2. VHOST FQDN
  The fully qualified domain name (FQDN) of the new vhost to create.  Example www.apache.org

Running the script will create the necessary configuration file(s) for Apache2.  The root directory for the new website will be /mnt/www/&lt;VHOST FQDN&gt;/htdocs.  Put the your web files there and you're all set!

## Postfix Email Relaying ##
The configuration for postfix is stored in a MySQL database, thus the input attributes for a postfix MySQL user, database, and password.  Right now, you'll need to get right into the MySQL commandline in order to manipulate the configuration but there are plans to make this much more user friendly in the future.

### Virtual Domains ###
The first thing you'll need to do is tell postfix which domain names it'll be handling email for.

When connected to the server with SSH, type `mysql` to get into a mysql commandline client.  Then type `use postfix;` to select the postfix configuration database.  If you supplied a different database name for the postfix configuration, substitute that in the use command.  Then, for each domain you want to handle email for, run the following MySQL query.

_INSERT INTO transport (domain,destination) VALUES ('yourdomain.com','virtual:')_

Where 'yourdomain.com' is the domain name you want to handle email for.

### Virtual User Aliases ###
Once you've defined the domain names that you'll be handling email for, you'll want to setup which email addresses you'll be accepting email for, and what email address to relay them to.

When connected to the server with SSH, type `mysql` to get into a mysql commandline client.  Then type `use postfix;` to select the postfix configuration database.  If you supplied a different database name for the postfix configuration, substitute that in the use command.  Then, for each email address you want to accept email for, run the following MySQL query.

_INSERT INTO virtual (email,destination) VALUES ('you@yourdomain.com','you@gmail.com')_

The first value is the email address which your server will accept email for.  The 'yourdomain.com' must already be in transport table, which you would have added in the "Virtual Domains" section above.

The second value is the email address you want any emails sent to the 'you@yourdomain.com' relayed to.  It's just that easy!

You can specify many different email addresses to be relayed to the same destination address.  You can also specify a "catchall" destination for a domain by excluding the user.  I.E. Supplying '@yourdomain.com' for the first value, and 'you@gmail.com' as the second value would route any email sent to any address @yourdomain.com to your gmail address.  It's not advisable, but it can be done.

# Managing Artifacts #
We've mentioned a couple times above that this server uses an EBS volume to store configuration and application data.  The creation of that EBS volume, and the creation of the snapshots for backups is fully automated.  The number of EBS snapshots for the current instance is even kept in check by the "aio_ebs_snapshots_to_keep" attribute.

However, when you launch a new instance to replace an existing one, some EBS artifacts get left behind which will need to be manually cleaned up.  Below you'll find information on what things to look out for.  Automating this cleanup is VERY high on my priority list for enhancements of this ServerTemplate.

## EBS Volumes ##
When you terminate a running instance of this server template, the automatically created EBS volume is not deleted.  So after performing the steps from the "Disaster Recovery or Vertical Scaling" section above, you'll want to look at the EBS volumes in the same region as the terminated instance, and go ahead and delete it.

You may want to verify that you have a current snapshot of the volume first, though you would probably have already done that before launching a new instance and terminating the old one.

## EBS Snapshots ##
Snapshots of the old EBS volume associated with a terminated instance are not automatically deleted by the backup script based on the "aio_ebs_snapshots_to_keep" attribute.  This is because the snapshots are not associated with the new volume or instance, so the script has no way of knowing that they are related.

As a result, you'll want to delete old snapshots which belong to terminated instances and/or deleted EBS volumes.

# Change Log #
* Rev 1
  * Initial release
* Rev 2
  * Replaced Apache with Nginx
  * Running PHP5 FPM application server rather than a PHP module for Apache or Nginx
  * Dropped incomplete support for Zend Framework
  * Dropped Gitosis as a default, since I imagine I'm the only person using it, and it's a bit out of place
  * Added Alerts for critical systems and failure/limp conditions
  * New MCI which includes RightLink 5.6.28 and creates an 8GB root partition rather than 10GB
  * Added ability to connect this server with the [Opscode](http://www.opscode.com/platform/) Chef platform to further customize your instance


# TODO #
* Setup a default vhost
  * Including an SSL vhost that hosts various tools like phpmyadmin and a management tool for email configuration etc.
* More alerts
  * Postfix high load
  * MySQL high load
  * Low memory
  * Nginx high load
* Reconsider ZendFramework support
* Enable gitweb (probably within aforementioned SSL vhost)
* Installation/Deployment/management recipes for Drupal? Maybe?
* Full and proper email stack (local delivery, pop3, imap, ldap configuration)</description>
    <name>LNMP &amp; Email Vhosting All-In-One with Nginx, PHP5-FPM, MySQL 5.1, and Postfix</name>
    <created_at>2011/12/08 18:18:04 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>1</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2012/02/28 23:03:21 +0000</updated_at>
    <publisher>Ryan Geyer</publisher>
    <content_type>CookbookRepoSequence</content_type>
    <commit_message>
      <text>Rev 1 - Initial Commit</text>
      <time>2012/02/28 22:36:16 +0000</time>
      <user>ryan.geyer@rightscale.com</user>
    </commit_message>
    <description></description>
    <name>CloudStack Management Server Single-Node</name>
    <created_at>2012/02/28 23:03:19 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>1</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes>Initial Commit</revision_notes>
    <updated_at>2012/02/28 23:03:21 +0000</updated_at>
    <publisher>Ryan Geyer</publisher>
    <content_type>ServerTemplate</content_type>
    <commit_message>
      <time>2012/02/28 22:56:22 +0000</time>
      <text>Initial Commit</text>
      <user>ryan.geyer@rightscale.com</user>
    </commit_message>
    <description>Configures a CloudStack 2.2.13 Single Node Management Server.  Based on the RightScale Database Manager for MySQL 5.1.

This template also enables an OpenVPN server which uses a self signed SSL/TLS certificate for encryption and authentication.  You can fetch a client configuration and key pair with the following;

scp root@hostname-or-ip-of-this-server:/etc/openvpn/keys/remote.tar.gz .

The default URL for the CloudStack management dashboard is;
http://hostname-or-ip-of-this-server:8080/client

The Default login is;
admin/password

See [the source cookbook](https://github.com/rgeyer/cookbooks_linux/tree/master/cookbooks/cloudstack) for more information.

------------------ Original Right Scale Database Manager Description -------------------------

The ServerTemplate supports multiple clouds, using either instance-based storage or attachable volumes. Instance-based snapshot backups are automatically uploaded to your choice of remote object storage (Amazon S3 or Rackspace Cloud Files). It also includes iptables management for clouds that do not have firewall services.

* Master or slave roles.
* Uses attachable volumes or instance-based LVM volumes for primary backup.
* Supports a secondary, disaster-recovery backup to S3 or Cloud Files remote object stores.
* Support for striping of external volumes for faster database performance.
* Continuous snapshot backups using a grandfather-father-son paradigm (on clouds with volume support).
* Assisted database restoration, including stripe re-creation.
* Provides scripts for master to slave fail-over, restoration of master, and more.
* Choice of DNS providers (DNS Made Easy, DynDNS, AWS Route53).
* iptables management within a three-tier scalable web architecture for clouds that do not have firewall services.
* Pre-configured monitoring and alerts.

See the [Database Manager for MySQL 5.1 (Chef) Database Setup](http://support.rightscale.com/12345-Tutorials/12345-AWS/12345-Website_Edition/Database_Setups/12345.1_MySQL_Setup/Create_a_MySQL-EBS_Database_Setup/Database_Manager_for_MySQL_5.1_(Chef\)_Database_Setup) guide to get started.

Supported compute clouds:

     * Amazon Web Services EC2 with EBS Volume Snapshot Support
     * Citrix CloudStack KVM/Xen/XenServer with Volume Snapshot Support
     * Eucalyptus
     * Rackspace

Supported primary backup methods:

     * Volume snapshots: AWS EC2, Citrix CloudStack, Eucalyptus
     * Remote Object Store Upload: AWS S3, Rackspace Cloud Files

Note: The snapshot backups from previous Database Managers (11H1 and older) are currently not compatible with this new Database Manager. You will have to do a manual migration of your data.</description>
    <name>CloudStack Management Server Single-Node</name>
    <created_at>2012/02/28 23:03:20 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>1</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2012/03/26 22:05:50 +0000</updated_at>
    <publisher>Ryan Geyer</publisher>
    <content_type>CookbookRepoSequence</content_type>
    <commit_message>
      <text>* Upgraded to CloudStack 2.2.14
* Improved OpenVPN configuration</text>
      <time>2012/03/26 22:03:54 +0000</time>
      <user>ryan.geyer@rightscale.com</user>
    </commit_message>
    <description></description>
    <name>CloudStack Management Server Single-Node</name>
    <created_at>2012/03/26 22:05:48 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>2</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes>* Upgraded to CloudStack 2.2.14
* Improved OpenVPN configuration</revision_notes>
    <updated_at>2012/03/26 22:05:50 +0000</updated_at>
    <publisher>Ryan Geyer</publisher>
    <content_type>ServerTemplate</content_type>
    <commit_message>
      <text>* Upgraded to CloudStack 2.2.14
* Improved OpenVPN configuration</text>
      <time>2012/03/26 22:04:51 +0000</time>
      <user>ryan.geyer@rightscale.com</user>
    </commit_message>
    <description>Configures a CloudStack 2.2.14 Single Node Management Server.  Based on the RightScale Database Manager for MySQL 5.1.

This template also enables an OpenVPN server which uses a self signed SSL/TLS certificate for encryption and authentication.  You can fetch a client configuration and key pair with the following;

scp root@hostname-or-ip-of-this-server:/etc/openvpn/keys/remote.tar.gz .

The default URL for the CloudStack management dashboard is;
http://hostname-or-ip-of-this-server:8080/client

The Default login is;
admin/password

See [the source cookbook](https://github.com/rgeyer/cookbooks_linux/tree/master/cookbooks/cloudstack) for more information.

------------------ Original Right Scale Database Manager Description -------------------------

The ServerTemplate supports multiple clouds, using either instance-based storage or attachable volumes. Instance-based snapshot backups are automatically uploaded to your choice of remote object storage (Amazon S3 or Rackspace Cloud Files). It also includes iptables management for clouds that do not have firewall services.

* Master or slave roles.
* Uses attachable volumes or instance-based LVM volumes for primary backup.
* Supports a secondary, disaster-recovery backup to S3 or Cloud Files remote object stores.
* Support for striping of external volumes for faster database performance.
* Continuous snapshot backups using a grandfather-father-son paradigm (on clouds with volume support).
* Assisted database restoration, including stripe re-creation.
* Provides scripts for master to slave fail-over, restoration of master, and more.
* Choice of DNS providers (DNS Made Easy, DynDNS, AWS Route53).
* iptables management within a three-tier scalable web architecture for clouds that do not have firewall services.
* Pre-configured monitoring and alerts.

See the [Database Manager for MySQL 5.1 (Chef) Database Setup](http://support.rightscale.com/12345-Tutorials/12345-AWS/12345-Website_Edition/Database_Setups/12345.1_MySQL_Setup/Create_a_MySQL-EBS_Database_Setup/Database_Manager_for_MySQL_5.1_(Chef\)_Database_Setup) guide to get started.

Supported compute clouds:

     * Amazon Web Services EC2 with EBS Volume Snapshot Support
     * Citrix CloudStack KVM/Xen/XenServer with Volume Snapshot Support
     * Eucalyptus
     * Rackspace

Supported primary backup methods:

     * Volume snapshots: AWS EC2, Citrix CloudStack, Eucalyptus
     * Remote Object Store Upload: AWS S3, Rackspace Cloud Files

Note: The snapshot backups from previous Database Managers (11H1 and older) are currently not compatible with this new Database Manager. You will have to do a manual migration of your data.</description>
    <name>CloudStack Management Server Single-Node</name>
    <created_at>2012/03/26 22:05:49 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>2</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2012/04/25 23:00:22 +0000</updated_at>
    <publisher>Ryan Geyer</publisher>
    <content_type>CookbookRepoSequence</content_type>
    <commit_message>
      <text>Initial Commit</text>
      <time>2012/04/25 22:48:49 +0000</time>
      <user>ryan.geyer@rightscale.com</user>
    </commit_message>
    <description></description>
    <name>RightScale Public + UOX</name>
    <created_at>2012/04/25 23:00:21 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>1</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes>Added Process "uox3" to process list for monitoring.</revision_notes>
    <updated_at>2012/04/25 23:00:22 +0000</updated_at>
    <publisher>Ryan Geyer</publisher>
    <content_type>ServerTemplate</content_type>
    <commit_message>
      <time>2012/04/25 22:59:22 +0000</time>
      <text>Added Process "uox3" to process list for monitoring.</text>
      <user>ryan.geyer@rightscale.com</user>
    </commit_message>
    <description>Stands up a single server running the UOX3 (Ultima Offline Experiment) game emulator.

The UOX3 binary runs in a screen session named "uox3" as the user "uox3", and is controlled by a SysV init script at /etc/init.d/uox3.

This ServerTemplate includes an alert which will notify the administrator if the uox3 process has ceased to run for over 5 minutes.

This ServerTemplate also includes monitors which show the current memory use, and number of online characters in the game.

Client/Multi files and Shard Backups
======================

Client files can be downloaded from a ROS, and the shard files can be backed up or restored from a ROS.  "ROS"
is an abbreviation for "Remote Object Store".

Currently supported ROS sources are;

* Amazon S3
* Rackspace CloudFiles and CloudFiles UK
* SoftLayer Dallas, Singapore, and Amsterdam.

Continuous (daily) backup of the shard files is enabled by default and can be disabled.  _Backups are not pruned automatically!_
You should plan to periodically clean up the shard files backups in the ROS.

Since the UO Client data (*.mul files) can not be distributed, you must first install UO and create a zip file containing those files.

A copy of the UO client files (the *.mul files in your game directory) are required and not distributed with this
cookbook.  The default recipe is configured to download those files from a ROS.

To make the *.mul files available, install UO on your windows computer, then put all of the *.mul files into a zip file.
Upload that zip file to one of the above supported ROS sources, then specify that source when launching your UOX server
with these recipes.</description>
    <name>Ultima Online Emulator (UOX3)</name>
    <created_at>2012/04/25 23:00:22 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>2</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2012/05/01 00:40:27 +0000</updated_at>
    <publisher>Ryan Geyer</publisher>
    <content_type>CookbookRepoSequence</content_type>
    <commit_message>
      <time>2012/05/01 00:12:14 +0000</time>
      <text>Cloudstack 3.0.x support.</text>
      <user>ryan.geyer@rightscale.com</user>
    </commit_message>
    <description></description>
    <name>CloudStack Management Server Single-Node</name>
    <created_at>2012/05/01 00:40:25 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>3</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes>Updated to latest DBManager base.

Added CloudStack 3.0.x install support</revision_notes>
    <updated_at>2012/05/01 00:44:52 +0000</updated_at>
    <publisher>Ryan Geyer</publisher>
    <content_type>ServerTemplate</content_type>
    <commit_message>
      <time>2012/05/01 00:37:36 +0000</time>
      <text>Updated to latest DBManager base.

Added CloudStack 3.0.x install support</text>
      <user>ryan.geyer@rightscale.com</user>
    </commit_message>
    <description>Configures a CloudStack 2.2.14 or the latest 3.0.x Single Node Management Server.  Based on the RightScale Database Manager for MySQL 5.1.

This template also enables an OpenVPN server which uses a self signed SSL/TLS certificate for encryption and authentication.  You can fetch a client configuration and key pair with the following;

scp root@hostname-or-ip-of-this-server:/etc/openvpn/keys/remote.tar.gz .

The default URL for the CloudStack management dashboard is;
http://hostname-or-ip-of-this-server:8080/client

The Default login is;
admin/password

See [the source cookbook](https://github.com/rgeyer/cookbooks_linux/tree/master/cookbooks/cloudstack) for more information.

------------------ Original Right Scale Database Manager Description -------------------------

Configures a MySQL 5.1 database server. This ServerTemplate provides a high-availability master/slave database configuration that can be used as the backbone for a variety of applications and workloads. 

The ServerTemplate supports multiple clouds, using either instance-based storage or attachable volumes. Instance-based snapshot backups are automatically uploaded to your choice of remote object storage (Amazon S3 or Rackspace Cloud Files). It also includes iptables management for clouds that do not have firewall services.

For the latest version of MySQL, see Database Manager for MySQL 5.5

__Key Features:__
* Master or slave roles.
* Uses attachable volumes or instance-based LVM volumes for primary backup.
* Supports a secondary, disaster-recovery backup to S3 or Cloud Files remote object stores.
* Support for striping of external volumes for faster database performance.
* Continuous snapshot backups using a grandfather-father-son paradigm (on clouds with volume support).
* Assisted database restoration, including stripe re-creation.
* Provides scripts for master to slave fail-over, restoration of master, and more.
* Choice of DNS providers (DNS Made Easy, DynDNS, AWS Route53).
* iptables management within a three-tier scalable web architecture for clouds that do not have firewall services.
* Pre-configured monitoring and alerts.

__Related ServerTemplates:__  
Load Balancer  
Tomcat App Server  
Apache-Rails-Passenger App Server  
PHP App Server

__Release Notes:__  
[Database Manager for MySQL 5.1 Release Notes](http://support.rightscale.com/12345-Release_Notes/ServerTemplates_and_RightImages/12345-03-26#Database_Manager_for_MySQL_5.1)

* * *

__Application versions:__
* MySQL 5.1.55

__Supported compute clouds:__
* Amazon Web Services EC2
* Citrix CloudStack
* IDC Frontier
* Logicworks
* Rackspace
* SoftLayer

__Supported backup clouds:__
* Amazon Web Services S3
* Rackspace CloudFiles (US and UK)
* Softlayer Swift (Dallas, Singapore, and Amsterdam)

__Supported primary backup methods:__
* Volume snapshots: AWS EC2, Citrix CloudStack
* Remote Object Store Upload: AWS S3, Rackspace Cloud Files, Softlayer

__Supported MultiCloud Images:__
* CentOS 5.6 - Amazon, CloudStack, IDC Frontier, Logicworks, Rackspace
* CentOS 5.7 - SoftLayer
* Ubuntu 10.04 - Amazon, Rackspace
* RHEL 5.6 - Amazon
</description>
    <name>CloudStack Management Server Single-Node</name>
    <created_at>2012/05/01 00:40:26 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>3</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes>Added SoftLayer image.  Pruned 32bit and KVM/VMWare images</revision_notes>
    <updated_at>2012/05/01 00:45:22 +0000</updated_at>
    <publisher>Ryan Geyer</publisher>
    <content_type>ServerTemplate</content_type>
    <commit_message>
      <text>Added SoftLayer image.  Pruned 32bit and KVM/VMWare images</text>
      <time>2012/05/01 00:44:33 +0000</time>
      <user>ryan.geyer@rightscale.com</user>
    </commit_message>
    <description>Configures a CloudStack 2.2.14 or the latest 3.0.x Single Node Management Server.  Based on the RightScale Database Manager for MySQL 5.1.

This template also enables an OpenVPN server which uses a self signed SSL/TLS certificate for encryption and authentication.  You can fetch a client configuration and key pair with the following;

scp root@hostname-or-ip-of-this-server:/etc/openvpn/keys/remote.tar.gz .

The default URL for the CloudStack management dashboard is;
http://hostname-or-ip-of-this-server:8080/client

The Default login is;
admin/password

See [the source cookbook](https://github.com/rgeyer/cookbooks_linux/tree/master/cookbooks/cloudstack) for more information.

------------------ Original Right Scale Database Manager Description -------------------------

Configures a MySQL 5.1 database server. This ServerTemplate provides a high-availability master/slave database configuration that can be used as the backbone for a variety of applications and workloads. 

The ServerTemplate supports multiple clouds, using either instance-based storage or attachable volumes. Instance-based snapshot backups are automatically uploaded to your choice of remote object storage (Amazon S3 or Rackspace Cloud Files). It also includes iptables management for clouds that do not have firewall services.

For the latest version of MySQL, see Database Manager for MySQL 5.5

__Key Features:__
* Master or slave roles.
* Uses attachable volumes or instance-based LVM volumes for primary backup.
* Supports a secondary, disaster-recovery backup to S3 or Cloud Files remote object stores.
* Support for striping of external volumes for faster database performance.
* Continuous snapshot backups using a grandfather-father-son paradigm (on clouds with volume support).
* Assisted database restoration, including stripe re-creation.
* Provides scripts for master to slave fail-over, restoration of master, and more.
* Choice of DNS providers (DNS Made Easy, DynDNS, AWS Route53).
* iptables management within a three-tier scalable web architecture for clouds that do not have firewall services.
* Pre-configured monitoring and alerts.

__Related ServerTemplates:__  
Load Balancer  
Tomcat App Server  
Apache-Rails-Passenger App Server  
PHP App Server

__Release Notes:__  
[Database Manager for MySQL 5.1 Release Notes](http://support.rightscale.com/12345-Release_Notes/ServerTemplates_and_RightImages/12345-03-26#Database_Manager_for_MySQL_5.1)

* * *

__Application versions:__
* MySQL 5.1.55

__Supported compute clouds:__
* Amazon Web Services EC2
* Citrix CloudStack
* IDC Frontier
* Logicworks
* Rackspace
* SoftLayer

__Supported backup clouds:__
* Amazon Web Services S3
* Rackspace CloudFiles (US and UK)
* Softlayer Swift (Dallas, Singapore, and Amsterdam)

__Supported primary backup methods:__
* Volume snapshots: AWS EC2, Citrix CloudStack
* Remote Object Store Upload: AWS S3, Rackspace Cloud Files, Softlayer

__Supported MultiCloud Images:__
* CentOS 5.6 - Amazon, CloudStack, IDC Frontier, Logicworks, Rackspace
* CentOS 5.7 - SoftLayer
* Ubuntu 10.04 - Amazon, Rackspace
* RHEL 5.6 - Amazon
</description>
    <name>CloudStack Management Server Single-Node</name>
    <created_at>2012/05/01 00:45:21 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>4</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2012/07/24 23:50:07 +0000</updated_at>
    <publisher>Ryan Geyer</publisher>
    <content_type>CookbookRepoSequence</content_type>
    <commit_message>
      <text>Initial Commit</text>
      <time>2012/07/24 23:08:15 +0000</time>
      <user>ryan.geyer@rightscale.com</user>
    </commit_message>
    <description></description>
    <name>RightScale (v12.11.0-LTS) + LNMP</name>
    <created_at>2012/07/24 23:50:04 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>1</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes>Rev 4 - RightScale v12.11.0-LTS assets and more..</revision_notes>
    <updated_at>2012/07/30 19:58:15 +0000</updated_at>
    <publisher>Ryan Geyer</publisher>
    <content_type>ServerTemplate</content_type>
    <commit_message>
      <time>2012/07/24 23:42:43 +0000</time>
      <text>Rev 4 - RightScale v12.11.0-LTS assets and more..</text>
      <user>ryan.geyer@rightscale.com</user>
    </commit_message>
    <description># Description #
This is an All-In-One (AIO) server for hosting PHP based web sites/applications, as well as email for one or many domain names (virtual hosting).

## Total Cost of Ownership ##
This ServerTemplate is designed to run within the confines of a [t1.micro](http://aws.amazon.com/ec2/instance-types/) EC2 instance.  A t1.micro instance requires that you use an EBS volume to store the operating system.  The MultiCloud Image this ServerTemplate uses automatically creates an 8GB EBS volume for this purpose.

This server template requires one additional EBS volume for storing configuration and application data, the size of which will vary based on what you're running.  The default size for this partition is 2GB.  Combined with the 8GB root partition the total EBS footprint is exactly 10GB, the maximum for the AWS free tier.

When you first sign up for AWS you can take advantage of their [free tier](http://aws.amazon.com/free/) for all services for one year.

While using this server template I've averaged $0.12 per month between EIP data transfer costs, and the additional EBS volume.

After one year when the free tier expires, you can expect to spend under $15 per month if you pay for a t1.micro reserved instance, broken down thusly.

* t1.micro reservation (heavy usage) for 1 year $62 ($5.17/mo but billed once at the beginning)
* 730hr t1.micro usage @$0.005/hr (Reserved cost in US-EAST cloud) $3.65/mo
* 8GB EBS Volume $0.80/mo
* 2GB EBS Volume $0.20/mo
* Snapshot Storage is variable depending on how you configure your retention policy.  Snapshots are incremental and store only the delta, so actual storage costs are quite low.

That totals out to $9.82/mo, which leaves $5.18 (out of $15) for data transfer, I/O requests and maybe some S3 storage.

As I personally run this more, I'll be able to give some more real world data, rather than just estimates.  The point though, is that this is dirt cheap given the control you have!

## LNMP Virtual Hosting ##
The web hosting environment is a full LNMP stack consisting of;

* Linux - CentOS 5.8
* Nginx - 1.2.2
* MySQL - 5.1.55-community
* PHP - 5.3.6

## Email Virtual Hosting ##
In addition to the LNMP stack, a Postfix server is installed and configured for virtual hosting of one or many email domains.  Currently, the postfix server is configured to relay email for configured email addresses (more information on that below) to one or more other email addresses.  I use this to accept email for a domain, and effectively "forward" it to my gmail account where I manage all of my email.

# Usage #

## Prerequisites ##

### Elastic IP ###
It is *HIGHLY* recommended that you setup an Elastic IP for your server instance if you run this on AWS.  This will make things like vertical scaling and disaster recovery easier.

In clouds besides AWS, or in absence of an Elastic IP you'll just have to make DNS changes and wait for those changes to propagate.

Also, if you're going to be serious about running an email server, using an EIP is the only way to go so you don't get blacklisted etc.  Setup an EIP, then make sure you fill out [this form](https://aws-portal.amazon.com/gp/aws/html-forms-controller/contactus/ec2-email-limit-rdns-request) to setup a reverse DNS record for your hostname (like mail.yourdomain.com) to your EIP.  You can read about why this is important [here](http://www.simpledns.com/kb.aspx?kbid=1052)

### Security Groups ###
You'll need to be able to communicate with your server from the interwebs.  This means you'll need to open some ports in one or more security groups, and add your server instance to those security groups.

In clouds which do not support security groups set the "Firewall" input to enabled, and all inbound access (besides the required ports listed below) will be blocked.

As a best practice, try to avoid making all of your changes to the "default" security group.  It's also better if you put the ports for each service in it's own security group, though just one security group which opens all ports for this server instance is probably okay too.  Here are the ports that are required to be able to communicate with this server.

* SSH - TCP:22
* SMTP - TCP:25
* HTTP - TCP:80
* HTTPS - TCP:443

## Launching for the first time ##
If you've just imported this ServerTemplate from the library, here's what you need to know to get started.

### Inputs ###
* Database Admin Password

  Pick a secure password for the database administrator.  The default administrator username is "administrator".  It's possible that you'll never need to use these credentials since the Chef recipes set everything up for you, but it's good to have in case of emergency or for administrative tasks not covered in an operational script etc.

* Postfix MySQL Database Password

  Pick a secure password for the user account that postfix will use to access the MySQL database.  Did I mention that Postfix configuration information is stored in MySQL?  I promise, I'll explain later.
* Total Volume Size (1)

  This server stores all of the data which needs to be persistent either on a separate attached storage volume, or on an LVM partition of your ephemeral storage to ease backups, disaster recovery, and vertical scaling.  Specify a volume size here that makes sense for the data you're storing, including MySQL databases and your web site/application html and code files.  **NOTE**: The default is 2GB

* Backup Lineage (1)

For the attached volume, and for the continuous backups a lineage needs to be specified.  This is effectively a name for the data backup, feel free to specify anything for this.  For all of the volume management stuff I'm making heavy use of the RightScale "Storage Toolbox", and this input comes from those tools.  Take a peek at the documentation and runbook for the "Storage Toolbox" [here](http://support.rightscale.com/12345-Tutorials/Storage_Toolbox/Storage_Toolbox_Runbook)

* Web Server Hostname

Some basic tools will get installed and hosted for this server on a particular hostname.  These are things like phpmyadmin, and (hopefully, eventually) some web UI tools for managing your server.  You can specify the hostname you want this to appear on.  I recommend that you use a hostname specific to the management of this server, like tools.domain.com etc.

If you're in a hurry, and just wanted to get this up and running quickly, that's all you'll need to know.

## Disaster Recovery or Vertical Scaling ##
As mentioned, all of the configuration and application data for all the services is stored on an attached or LVM managed volume.  That volume has a snapshot taken of it once per day.  Those snapshots can be used to start a new instance of this server with the data and configuration exactly as it was at that point in time.

This is useful for vertical scaling.  I.E. Using a bigger, badder instance type to manage more traffic.  It's also useful for disaster recovery.

To bring up a new instance from a snapshot, these are the steps.

1. Find the AWS ID of the latest snapshot for your data volume
  * Alternate first step is to create a snapshot "right now" by running the "block_device::do_primary_backup" or "block_device::do_secondary_backup" recipe on the current instance.
2. Add a new server to your deployment using this ServerTemplate
3. Click "Launch" and set all of your inputs to the desired values
4. Launch the new instance
5. Run the "nginx::setup_vhost" or "app_wordpress::deploy" (which ever is appropriate) once for each vhosted domain this server answers for.
6. Verify web and email vhosts are working properly (change /etc/hosts file to point to new IP etc)
7. Change your DNS records from the IP of the old instance, to the new one
  * **Pro Tip**: Or, if you're using an Elastic IP, just reassign the the EIP to the new instance
8. Once DNS records are propagated, or EIP remap is finished, decommission old instance
9. Clean up volume and snapshots of old instance
  * See "Managing Artifacts" below

# Configuring Services #

## Wordpress Powered Website ##
If you want to host a Wordpress powered website, you're only a few inputs and clicks away

Inputs
1. MySQL Database Password for this Wordpress instance
  Pick a secure password which Wordpress will use to access the database.  The Wordpress configuration file will automatically be created with this information
2. VHOST Aliases
  The possible hostname aliases (if any) for the vhost.  For instance to host the same content at www.yourdomain.com and yourdomain.com simply put "yourdomain.com" here.  Many values can be supplied, separated by spaces.  If you don't want any aliases leave the text missing in this field.
3. VHOST FQDN
  The fully qualified domain name (FQDN) of the new vhost to create.  Example www.apache.org

## Website ##
If you want to host a website that's just static HTML, or a mix of HTML and some PHP files, you can set it up by running the "nginx::setup_vhost" script.

This script takes only two inputs.
1. VHOST Aliases
  The possible hostname aliases (if any) for the vhost.  For instance to host the same content at www.yourdomain.com and yourdomain.com simply put "yourdomain.com" here.  Many values can be supplied, separated by spaces.  If you don't want any aliases leave the field empty.
2. VHOST FQDN
  The fully qualified domain name (FQDN) of the new vhost to create.  Example www.apache.org

Running the script will create the necessary configuration file(s) for Apache2.  The root directory for the new website will be /mnt/storage/www/&lt;VHOST FQDN&gt;/htdocs.  Put the your web files there and you're all set!

## Postfix Email Relaying ##
The configuration for postfix is stored in a MySQL database, thus the input attributes for a postfix MySQL user, database, and password.  Right now, you'll need to get right into the MySQL commandline in order to manipulate the configuration but there are plans to make this much more user friendly in the future.

### Virtual Domains ###
The first thing you'll need to do is tell postfix which domain names it'll be handling email for.

When connected to the server with SSH, type `mysql` to get into a mysql commandline client.  Then type `use postfix;` to select the postfix configuration database.  If you supplied a different database name for the postfix configuration, substitute that in the use command.  Then, for each domain you want to handle email for, run the following MySQL query.

_INSERT INTO transport (domain,destination) VALUES ('yourdomain.com','virtual:')_

Where 'yourdomain.com' is the domain name you want to handle email for.

### Virtual User Aliases ###
Once you've defined the domain names that you'll be handling email for, you'll want to setup which email addresses you'll be accepting email for, and what email address to relay them to.

When connected to the server with SSH, type `mysql` to get into a mysql commandline client.  Then type `use postfix;` to select the postfix configuration database.  If you supplied a different database name for the postfix configuration, substitute that in the use command.  Then, for each email address you want to accept email for, run the following MySQL query.

_INSERT INTO virtual (email,destination) VALUES ('you@yourdomain.com','you@gmail.com')_

The first value is the email address which your server will accept email for.  The 'yourdomain.com' must already be in transport table, which you would have added in the "Virtual Domains" section above.

The second value is the email address you want any emails sent to the 'you@yourdomain.com' relayed to.  It's just that easy!

You can specify many different email addresses to be relayed to the same destination address.  You can also specify a "catchall" destination for a domain by excluding the user.  I.E. Supplying '@yourdomain.com' for the first value, and 'you@gmail.com' as the second value would route any email sent to any address @yourdomain.com to your gmail address.  It's not advisable, but it can be done.

# Managing Artifacts #
We've mentioned a couple times above that this server uses attachable volumes (where available) to store configuration and application data.  The creation of that volume, and the creation of the snapshots for backups is fully automated.  The number of snapshots for the current instance is even kept in check by the backup policy inputs.

However, when you launch a new instance to replace an existing one, some artifacts get left behind which will need to be manually cleaned up.  Below you'll find information on what things to look out for.  Automating this cleanup is VERY high on my priority list for enhancements of this ServerTemplate.

## Volumes ##
When you terminate a running instance of this server template, the automatically created volume is not deleted.  So after performing the steps from the "Disaster Recovery or Vertical Scaling" section above, you'll want to look at the volumes in the same cloud as the terminated instance, and go ahead and delete it.

You may want to verify that you have a current snapshot of the volume first, though you would probably have already done that before launching a new instance and terminating the old one.

## Snapshots ##
Snapshots of the old volume associated with a terminated instance are not automatically deleted by the backup script based.  This is because the snapshots are not associated with the new volume or instance, so the script has no way of knowing that they are related.

As a result, you'll want to delete old snapshots which belong to terminated instances and/or deleted volumes.

# Change Log #
* Rev 1
  * Initial release
* Rev 2
  * Replaced Apache with Nginx
  * Running PHP5 FPM application server rather than a PHP module for Apache or Nginx
  * Dropped incomplete support for Zend Framework
  * Dropped Gitosis as a default, since I imagine I'm the only person using it, and it's a bit out of place
  * Added Alerts for critical systems and failure/limp conditions
  * New MCI which includes RightLink 5.6.28 and creates an 8GB root partition rather than 10GB
  * Added ability to connect this server with the [Opscode](http://www.opscode.com/platform/) Chef platform to further customize your instance
* Rev 4
  * Updated to latest RightScale assets (RightLink 5.8, Storage Toolbox, etc)
  * Added a default vhost with phpmyadmin


# TODO #
* Setup a default vhost
  * Including an SSL vhost that hosts various tools like phpmyadmin and a management tool for email configuration etc.
    * This is partially done, in that phpmyadmin is deployed in a default vhost that redirects to SSL
* More alerts
  * Postfix high load
  * MySQL high load
  * Low memory
  * Nginx high load
* Reconsider ZendFramework support
* Enable gitweb (probably within aforementioned SSL vhost)
* Full and proper email stack (local delivery, pop3, imap, ldap configuration)</description>
    <name>Wordpress &amp; Email All-In-One</name>
    <created_at>2012/07/24 23:50:05 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>4</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2012/07/30 19:58:02 +0000</updated_at>
    <publisher>Ryan Geyer</publisher>
    <content_type>CookbookRepoSequence</content_type>
    <commit_message>
      <text>Rev 2 - Use a public copy of the rightscale_cookbooks repo</text>
      <time>2012/07/30 19:54:37 +0000</time>
      <user>ryan.geyer@rightscale.com</user>
    </commit_message>
    <description></description>
    <name>RightScale (v12.11.0-LTS) + LNMP</name>
    <created_at>2012/07/30 19:57:59 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>2</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes>Rev 5 - Use Rev 2 of the RepoPath, which includes a public version of the rightscale_cookbooks repo suitable for public consumption. :)</revision_notes>
    <updated_at>2012/08/06 21:59:28 +0000</updated_at>
    <publisher>Ryan Geyer</publisher>
    <content_type>ServerTemplate</content_type>
    <commit_message>
      <time>2012/07/30 19:57:35 +0000</time>
      <text>Rev 5 - Use Rev 2 of the RepoPath, which includes a public version of the rightscale_cookbooks repo suitable for public consumption. :)</text>
      <user>ryan.geyer@rightscale.com</user>
    </commit_message>
    <description># Description #
This is an All-In-One (AIO) server for hosting PHP based web sites/applications, as well as email for one or many domain names (virtual hosting).

## Total Cost of Ownership ##
This ServerTemplate is designed to run within the confines of a [t1.micro](http://aws.amazon.com/ec2/instance-types/) EC2 instance.  A t1.micro instance requires that you use an EBS volume to store the operating system.  The MultiCloud Image this ServerTemplate uses automatically creates an 8GB EBS volume for this purpose.

This server template requires one additional EBS volume for storing configuration and application data, the size of which will vary based on what you're running.  The default size for this partition is 2GB.  Combined with the 8GB root partition the total EBS footprint is exactly 10GB, the maximum for the AWS free tier.

When you first sign up for AWS you can take advantage of their [free tier](http://aws.amazon.com/free/) for all services for one year.

While using this server template I've averaged $0.12 per month between EIP data transfer costs, and the additional EBS volume.

After one year when the free tier expires, you can expect to spend under $15 per month if you pay for a t1.micro reserved instance, broken down thusly.

* t1.micro reservation (heavy usage) for 1 year $62 ($5.17/mo but billed once at the beginning)
* 730hr t1.micro usage @$0.005/hr (Reserved cost in US-EAST cloud) $3.65/mo
* 8GB EBS Volume $0.80/mo
* 2GB EBS Volume $0.20/mo
* Snapshot Storage is variable depending on how you configure your retention policy.  Snapshots are incremental and store only the delta, so actual storage costs are quite low.

That totals out to $9.82/mo, which leaves $5.18 (out of $15) for data transfer, I/O requests and maybe some S3 storage.

As I personally run this more, I'll be able to give some more real world data, rather than just estimates.  The point though, is that this is dirt cheap given the control you have!

## LNMP Virtual Hosting ##
The web hosting environment is a full LNMP stack consisting of;

* Linux - CentOS 5.8
* Nginx - 1.2.2
* MySQL - 5.1.55-community
* PHP - 5.3.6

## Email Virtual Hosting ##
In addition to the LNMP stack, a Postfix server is installed and configured for virtual hosting of one or many email domains.  Currently, the postfix server is configured to relay email for configured email addresses (more information on that below) to one or more other email addresses.  I use this to accept email for a domain, and effectively "forward" it to my gmail account where I manage all of my email.

# Usage #

## Prerequisites ##

### Elastic IP ###
It is *HIGHLY* recommended that you setup an Elastic IP for your server instance if you run this on AWS.  This will make things like vertical scaling and disaster recovery easier.

In clouds besides AWS, or in absence of an Elastic IP you'll just have to make DNS changes and wait for those changes to propagate.

Also, if you're going to be serious about running an email server, using an EIP is the only way to go so you don't get blacklisted etc.  Setup an EIP, then make sure you fill out [this form](https://aws-portal.amazon.com/gp/aws/html-forms-controller/contactus/ec2-email-limit-rdns-request) to setup a reverse DNS record for your hostname (like mail.yourdomain.com) to your EIP.  You can read about why this is important [here](http://www.simpledns.com/kb.aspx?kbid=1052)

### Security Groups ###
You'll need to be able to communicate with your server from the interwebs.  This means you'll need to open some ports in one or more security groups, and add your server instance to those security groups.

In clouds which do not support security groups set the "Firewall" input to enabled, and all inbound access (besides the required ports listed below) will be blocked.

As a best practice, try to avoid making all of your changes to the "default" security group.  It's also better if you put the ports for each service in it's own security group, though just one security group which opens all ports for this server instance is probably okay too.  Here are the ports that are required to be able to communicate with this server.

* SSH - TCP:22
* SMTP - TCP:25
* HTTP - TCP:80
* HTTPS - TCP:443

## Launching for the first time ##
If you've just imported this ServerTemplate from the library, here's what you need to know to get started.

### Inputs ###
* Database Admin Password

  Pick a secure password for the database administrator.  The default administrator username is "administrator".  It's possible that you'll never need to use these credentials since the Chef recipes set everything up for you, but it's good to have in case of emergency or for administrative tasks not covered in an operational script etc.

* Postfix MySQL Database Password

  Pick a secure password for the user account that postfix will use to access the MySQL database.  Did I mention that Postfix configuration information is stored in MySQL?  I promise, I'll explain later.
* Total Volume Size (1)

  This server stores all of the data which needs to be persistent either on a separate attached storage volume, or on an LVM partition of your ephemeral storage to ease backups, disaster recovery, and vertical scaling.  Specify a volume size here that makes sense for the data you're storing, including MySQL databases and your web site/application html and code files.  **NOTE**: The default is 2GB

* Backup Lineage (1)

For the attached volume, and for the continuous backups a lineage needs to be specified.  This is effectively a name for the data backup, feel free to specify anything for this.  For all of the volume management stuff I'm making heavy use of the RightScale "Storage Toolbox", and this input comes from those tools.  Take a peek at the documentation and runbook for the "Storage Toolbox" [here](http://support.rightscale.com/12345-Tutorials/Storage_Toolbox/Storage_Toolbox_Runbook)

* Web Server Hostname

Some basic tools will get installed and hosted for this server on a particular hostname.  These are things like phpmyadmin, and (hopefully, eventually) some web UI tools for managing your server.  You can specify the hostname you want this to appear on.  I recommend that you use a hostname specific to the management of this server, like tools.domain.com etc.

If you're in a hurry, and just wanted to get this up and running quickly, that's all you'll need to know.

## Disaster Recovery or Vertical Scaling ##
As mentioned, all of the configuration and application data for all the services is stored on an attached or LVM managed volume.  That volume has a snapshot taken of it once per day.  Those snapshots can be used to start a new instance of this server with the data and configuration exactly as it was at that point in time.

This is useful for vertical scaling.  I.E. Using a bigger, badder instance type to manage more traffic.  It's also useful for disaster recovery.

To bring up a new instance from a snapshot, these are the steps.

1. Find the AWS ID of the latest snapshot for your data volume
  * Alternate first step is to create a snapshot "right now" by running the "block_device::do_primary_backup" or "block_device::do_secondary_backup" recipe on the current instance.
2. Add a new server to your deployment using this ServerTemplate
3. Click "Launch" and set all of your inputs to the desired values
4. Launch the new instance
5. Run the "nginx::setup_vhost" or "app_wordpress::deploy" (which ever is appropriate) once for each vhosted domain this server answers for.
6. Verify web and email vhosts are working properly (change /etc/hosts file to point to new IP etc)
7. Change your DNS records from the IP of the old instance, to the new one
  * **Pro Tip**: Or, if you're using an Elastic IP, just reassign the the EIP to the new instance
8. Once DNS records are propagated, or EIP remap is finished, decommission old instance
9. Clean up volume and snapshots of old instance
  * See "Managing Artifacts" below

# Configuring Services #

## Wordpress Powered Website ##
If you want to host a Wordpress powered website, you're only a few inputs and clicks away

Inputs
1. MySQL Database Password for this Wordpress instance
  Pick a secure password which Wordpress will use to access the database.  The Wordpress configuration file will automatically be created with this information
2. VHOST Aliases
  The possible hostname aliases (if any) for the vhost.  For instance to host the same content at www.yourdomain.com and yourdomain.com simply put "yourdomain.com" here.  Many values can be supplied, separated by spaces.  If you don't want any aliases leave the text missing in this field.
3. VHOST FQDN
  The fully qualified domain name (FQDN) of the new vhost to create.  Example www.apache.org

## Website ##
If you want to host a website that's just static HTML, or a mix of HTML and some PHP files, you can set it up by running the "nginx::setup_vhost" script.

This script takes only two inputs.
1. VHOST Aliases
  The possible hostname aliases (if any) for the vhost.  For instance to host the same content at www.yourdomain.com and yourdomain.com simply put "yourdomain.com" here.  Many values can be supplied, separated by spaces.  If you don't want any aliases leave the field empty.
2. VHOST FQDN
  The fully qualified domain name (FQDN) of the new vhost to create.  Example www.apache.org

Running the script will create the necessary configuration file(s) for Apache2.  The root directory for the new website will be /mnt/storage/www/&lt;VHOST FQDN&gt;/htdocs.  Put the your web files there and you're all set!

## Postfix Email Relaying ##
The configuration for postfix is stored in a MySQL database, thus the input attributes for a postfix MySQL user, database, and password.  Right now, you'll need to get right into the MySQL commandline in order to manipulate the configuration but there are plans to make this much more user friendly in the future.

### Virtual Domains ###
The first thing you'll need to do is tell postfix which domain names it'll be handling email for.

When connected to the server with SSH, type `mysql` to get into a mysql commandline client.  Then type `use postfix;` to select the postfix configuration database.  If you supplied a different database name for the postfix configuration, substitute that in the use command.  Then, for each domain you want to handle email for, run the following MySQL query.

_INSERT INTO transport (domain,destination) VALUES ('yourdomain.com','virtual:')_

Where 'yourdomain.com' is the domain name you want to handle email for.

### Virtual User Aliases ###
Once you've defined the domain names that you'll be handling email for, you'll want to setup which email addresses you'll be accepting email for, and what email address to relay them to.

When connected to the server with SSH, type `mysql` to get into a mysql commandline client.  Then type `use postfix;` to select the postfix configuration database.  If you supplied a different database name for the postfix configuration, substitute that in the use command.  Then, for each email address you want to accept email for, run the following MySQL query.

_INSERT INTO virtual (email,destination) VALUES ('you@yourdomain.com','you@gmail.com')_

The first value is the email address which your server will accept email for.  The 'yourdomain.com' must already be in transport table, which you would have added in the "Virtual Domains" section above.

The second value is the email address you want any emails sent to the 'you@yourdomain.com' relayed to.  It's just that easy!

You can specify many different email addresses to be relayed to the same destination address.  You can also specify a "catchall" destination for a domain by excluding the user.  I.E. Supplying '@yourdomain.com' for the first value, and 'you@gmail.com' as the second value would route any email sent to any address @yourdomain.com to your gmail address.  It's not advisable, but it can be done.

# Managing Artifacts #
We've mentioned a couple times above that this server uses attachable volumes (where available) to store configuration and application data.  The creation of that volume, and the creation of the snapshots for backups is fully automated.  The number of snapshots for the current instance is even kept in check by the backup policy inputs.

However, when you launch a new instance to replace an existing one, some artifacts get left behind which will need to be manually cleaned up.  Below you'll find information on what things to look out for.  Automating this cleanup is VERY high on my priority list for enhancements of this ServerTemplate.

## Volumes ##
When you terminate a running instance of this server template, the automatically created volume is not deleted.  So after performing the steps from the "Disaster Recovery or Vertical Scaling" section above, you'll want to look at the volumes in the same cloud as the terminated instance, and go ahead and delete it.

You may want to verify that you have a current snapshot of the volume first, though you would probably have already done that before launching a new instance and terminating the old one.

## Snapshots ##
Snapshots of the old volume associated with a terminated instance are not automatically deleted by the backup script based.  This is because the snapshots are not associated with the new volume or instance, so the script has no way of knowing that they are related.

As a result, you'll want to delete old snapshots which belong to terminated instances and/or deleted volumes.

# Change Log #
* Rev 1
  * Initial release
* Rev 2
  * Replaced Apache with Nginx
  * Running PHP5 FPM application server rather than a PHP module for Apache or Nginx
  * Dropped incomplete support for Zend Framework
  * Dropped Gitosis as a default, since I imagine I'm the only person using it, and it's a bit out of place
  * Added Alerts for critical systems and failure/limp conditions
  * New MCI which includes RightLink 5.6.28 and creates an 8GB root partition rather than 10GB
  * Added ability to connect this server with the [Opscode](http://www.opscode.com/platform/) Chef platform to further customize your instance
* Rev 4
  * Updated to latest RightScale assets (RightLink 5.8, Storage Toolbox, etc)
  * Added a default vhost with phpmyadmin
* Rev 5
  * Changes to Chef repository to allow public access


# TODO #
* Setup a default vhost
  * Including an SSL vhost that hosts various tools like phpmyadmin and a management tool for email configuration etc.
    * This is partially done, in that phpmyadmin is deployed in a default vhost that redirects to SSL
* More alerts
  * Postfix high load
  * MySQL high load
  * Low memory
  * Nginx high load
* Reconsider ZendFramework support
* Enable gitweb (probably within aforementioned SSL vhost)
* Full and proper email stack (local delivery, pop3, imap, ldap configuration)</description>
    <name>Wordpress &amp; Email All-In-One</name>
    <created_at>2012/07/30 19:58:00 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>5</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2012/08/06 21:59:07 +0000</updated_at>
    <publisher>Ryan Geyer</publisher>
    <content_type>CookbookRepoSequence</content_type>
    <commit_message>
      <text>Rev3: Some rightscale_tools updates for EBS backed instances.</text>
      <time>2012/08/06 21:57:14 +0000</time>
      <user>ryan.geyer@rightscale.com</user>
    </commit_message>
    <description></description>
    <name>RightScale (v12.11.0-LTS) + LNMP</name>
    <created_at>2012/08/06 21:59:04 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>3</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes>Rev 6 : Better defaults for Nginx, Proper support for EBS Backed instances</revision_notes>
    <updated_at>2012/08/26 05:30:29 +0000</updated_at>
    <publisher>Ryan Geyer</publisher>
    <content_type>ServerTemplate</content_type>
    <commit_message>
      <time>2012/08/06 21:58:36 +0000</time>
      <text>Rev 6 : Better defaults for Nginx, Proper support for EBS Backed instances</text>
      <user>ryan.geyer@rightscale.com</user>
    </commit_message>
    <description># Description #
This is an All-In-One (AIO) server for hosting PHP based web sites/applications, as well as email for one or many domain names (virtual hosting).

## Total Cost of Ownership ##
This ServerTemplate is designed to run within the confines of a [t1.micro](http://aws.amazon.com/ec2/instance-types/) EC2 instance.  A t1.micro instance requires that you use an EBS volume to store the operating system.  The MultiCloud Image this ServerTemplate uses automatically creates an 8GB EBS volume for this purpose.

This server template requires one additional EBS volume for storing configuration and application data, the size of which will vary based on what you're running.  The default size for this partition is 2GB.  Combined with the 8GB root partition the total EBS footprint is exactly 10GB, the maximum for the AWS free tier.

When you first sign up for AWS you can take advantage of their [free tier](http://aws.amazon.com/free/) for all services for one year.

While using this server template I've averaged $0.12 per month between EIP data transfer costs, and the additional EBS volume.

After one year when the free tier expires, you can expect to spend under $15 per month if you pay for a t1.micro reserved instance, broken down thusly.

* t1.micro reservation (heavy usage) for 1 year $62 ($5.17/mo but billed once at the beginning)
* 730hr t1.micro usage @$0.005/hr (Reserved cost in US-EAST cloud) $3.65/mo
* 8GB EBS Volume $0.80/mo
* 2GB EBS Volume $0.20/mo
* Snapshot Storage is variable depending on how you configure your retention policy.  Snapshots are incremental and store only the delta, so actual storage costs are quite low.

That totals out to $9.82/mo, which leaves $5.18 (out of $15) for data transfer, I/O requests and maybe some S3 storage.

As I personally run this more, I'll be able to give some more real world data, rather than just estimates.  The point though, is that this is dirt cheap given the control you have!

## LNMP Virtual Hosting ##
The web hosting environment is a full LNMP stack consisting of;

* Linux - CentOS 5.8
* Nginx - 1.2.2
* MySQL - 5.1.55-community
* PHP - 5.3.6

## Email Virtual Hosting ##
In addition to the LNMP stack, a Postfix server is installed and configured for virtual hosting of one or many email domains.  Currently, the postfix server is configured to relay email for configured email addresses (more information on that below) to one or more other email addresses.  I use this to accept email for a domain, and effectively "forward" it to my gmail account where I manage all of my email.

# Usage #

## Prerequisites ##

### Elastic IP ###
It is *HIGHLY* recommended that you setup an Elastic IP for your server instance if you run this on AWS.  This will make things like vertical scaling and disaster recovery easier.

In clouds besides AWS, or in absence of an Elastic IP you'll just have to make DNS changes and wait for those changes to propagate.

Also, if you're going to be serious about running an email server, using an EIP is the only way to go so you don't get blacklisted etc.  Setup an EIP, then make sure you fill out [this form](https://aws-portal.amazon.com/gp/aws/html-forms-controller/contactus/ec2-email-limit-rdns-request) to setup a reverse DNS record for your hostname (like mail.yourdomain.com) to your EIP.  You can read about why this is important [here](http://www.simpledns.com/kb.aspx?kbid=1052)

### Security Groups ###
You'll need to be able to communicate with your server from the interwebs.  This means you'll need to open some ports in one or more security groups, and add your server instance to those security groups.

In clouds which do not support security groups set the "Firewall" input to enabled, and all inbound access (besides the required ports listed below) will be blocked.

As a best practice, try to avoid making all of your changes to the "default" security group.  It's also better if you put the ports for each service in it's own security group, though just one security group which opens all ports for this server instance is probably okay too.  Here are the ports that are required to be able to communicate with this server.

* SSH - TCP:22
* SMTP - TCP:25
* HTTP - TCP:80
* HTTPS - TCP:443

## Launching for the first time ##
If you've just imported this ServerTemplate from the library, here's what you need to know to get started.

### Inputs ###
* Database Admin Password

  Pick a secure password for the database administrator.  The default administrator username is "administrator".  It's possible that you'll never need to use these credentials since the Chef recipes set everything up for you, but it's good to have in case of emergency or for administrative tasks not covered in an operational script etc.

* Postfix MySQL Database Password

  Pick a secure password for the user account that postfix will use to access the MySQL database.  Did I mention that Postfix configuration information is stored in MySQL?  I promise, I'll explain later.
* Total Volume Size (1)

  This server stores all of the data which needs to be persistent either on a separate attached storage volume, or on an LVM partition of your ephemeral storage to ease backups, disaster recovery, and vertical scaling.  Specify a volume size here that makes sense for the data you're storing, including MySQL databases and your web site/application html and code files.  **NOTE**: The default is 2GB

* Backup Lineage (1)

For the attached volume, and for the continuous backups a lineage needs to be specified.  This is effectively a name for the data backup, feel free to specify anything for this.  For all of the volume management stuff I'm making heavy use of the RightScale "Storage Toolbox", and this input comes from those tools.  Take a peek at the documentation and runbook for the "Storage Toolbox" [here](http://support.rightscale.com/12345-Tutorials/Storage_Toolbox/Storage_Toolbox_Runbook)

* Web Server Hostname

Some basic tools will get installed and hosted for this server on a particular hostname.  These are things like phpmyadmin, and (hopefully, eventually) some web UI tools for managing your server.  You can specify the hostname you want this to appear on.  I recommend that you use a hostname specific to the management of this server, like tools.domain.com etc.

If you're in a hurry, and just wanted to get this up and running quickly, that's all you'll need to know.

## Disaster Recovery or Vertical Scaling ##
As mentioned, all of the configuration and application data for all the services is stored on an attached or LVM managed volume.  That volume has a snapshot taken of it once per day.  Those snapshots can be used to start a new instance of this server with the data and configuration exactly as it was at that point in time.

This is useful for vertical scaling.  I.E. Using a bigger, badder instance type to manage more traffic.  It's also useful for disaster recovery.

To bring up a new instance from a snapshot, these are the steps.

1. Find the AWS ID of the latest snapshot for your data volume
  * Alternate first step is to create a snapshot "right now" by running the "block_device::do_primary_backup" or "block_device::do_secondary_backup" recipe on the current instance.
2. Add a new server to your deployment using this ServerTemplate
3. Click "Launch" and set all of your inputs to the desired values
4. Launch the new instance
5. Run the "nginx::setup_vhost" or "app_wordpress::deploy" (which ever is appropriate) once for each vhosted domain this server answers for.
6. Verify web and email vhosts are working properly (change /etc/hosts file to point to new IP etc)
7. Change your DNS records from the IP of the old instance, to the new one
  * **Pro Tip**: Or, if you're using an Elastic IP, just reassign the the EIP to the new instance
8. Once DNS records are propagated, or EIP remap is finished, decommission old instance
9. Clean up volume and snapshots of old instance
  * See "Managing Artifacts" below

# Configuring Services #

## Wordpress Powered Website ##
If you want to host a Wordpress powered website, you're only a few inputs and clicks away

Inputs
1. MySQL Database Password for this Wordpress instance
  Pick a secure password which Wordpress will use to access the database.  The Wordpress configuration file will automatically be created with this information
2. VHOST Aliases
  The possible hostname aliases (if any) for the vhost.  For instance to host the same content at www.yourdomain.com and yourdomain.com simply put "yourdomain.com" here.  Many values can be supplied, separated by spaces.  If you don't want any aliases leave the text missing in this field.
3. VHOST FQDN
  The fully qualified domain name (FQDN) of the new vhost to create.  Example www.apache.org

## Website ##
If you want to host a website that's just static HTML, or a mix of HTML and some PHP files, you can set it up by running the "nginx::setup_vhost" script.

This script takes only two inputs.
1. VHOST Aliases
  The possible hostname aliases (if any) for the vhost.  For instance to host the same content at www.yourdomain.com and yourdomain.com simply put "yourdomain.com" here.  Many values can be supplied, separated by spaces.  If you don't want any aliases leave the field empty.
2. VHOST FQDN
  The fully qualified domain name (FQDN) of the new vhost to create.  Example www.apache.org

Running the script will create the necessary configuration file(s) for Apache2.  The root directory for the new website will be /mnt/storage/www/&lt;VHOST FQDN&gt;/htdocs.  Put the your web files there and you're all set!

## Postfix Email Relaying ##
The configuration for postfix is stored in a MySQL database, thus the input attributes for a postfix MySQL user, database, and password.  Right now, you'll need to get right into the MySQL commandline in order to manipulate the configuration but there are plans to make this much more user friendly in the future.

### Virtual Domains ###
The first thing you'll need to do is tell postfix which domain names it'll be handling email for.

When connected to the server with SSH, type `mysql` to get into a mysql commandline client.  Then type `use postfix;` to select the postfix configuration database.  If you supplied a different database name for the postfix configuration, substitute that in the use command.  Then, for each domain you want to handle email for, run the following MySQL query.

_INSERT INTO transport (domain,destination) VALUES ('yourdomain.com','virtual:')_

Where 'yourdomain.com' is the domain name you want to handle email for.

### Virtual User Aliases ###
Once you've defined the domain names that you'll be handling email for, you'll want to setup which email addresses you'll be accepting email for, and what email address to relay them to.

When connected to the server with SSH, type `mysql` to get into a mysql commandline client.  Then type `use postfix;` to select the postfix configuration database.  If you supplied a different database name for the postfix configuration, substitute that in the use command.  Then, for each email address you want to accept email for, run the following MySQL query.

_INSERT INTO virtual (email,destination) VALUES ('you@yourdomain.com','you@gmail.com')_

The first value is the email address which your server will accept email for.  The 'yourdomain.com' must already be in transport table, which you would have added in the "Virtual Domains" section above.

The second value is the email address you want any emails sent to the 'you@yourdomain.com' relayed to.  It's just that easy!

You can specify many different email addresses to be relayed to the same destination address.  You can also specify a "catchall" destination for a domain by excluding the user.  I.E. Supplying '@yourdomain.com' for the first value, and 'you@gmail.com' as the second value would route any email sent to any address @yourdomain.com to your gmail address.  It's not advisable, but it can be done.

# Managing Artifacts #
We've mentioned a couple times above that this server uses attachable volumes (where available) to store configuration and application data.  The creation of that volume, and the creation of the snapshots for backups is fully automated.  The number of snapshots for the current instance is even kept in check by the backup policy inputs.

However, when you launch a new instance to replace an existing one, some artifacts get left behind which will need to be manually cleaned up.  Below you'll find information on what things to look out for.  Automating this cleanup is VERY high on my priority list for enhancements of this ServerTemplate.

## Volumes ##
When you terminate a running instance of this server template, the automatically created volume is not deleted.  So after performing the steps from the "Disaster Recovery or Vertical Scaling" section above, you'll want to look at the volumes in the same cloud as the terminated instance, and go ahead and delete it.

You may want to verify that you have a current snapshot of the volume first, though you would probably have already done that before launching a new instance and terminating the old one.

## Snapshots ##
Snapshots of the old volume associated with a terminated instance are not automatically deleted by the backup script based.  This is because the snapshots are not associated with the new volume or instance, so the script has no way of knowing that they are related.

As a result, you'll want to delete old snapshots which belong to terminated instances and/or deleted volumes.

# Change Log #
* Rev 1
  * Initial release
* Rev 2
  * Replaced Apache with Nginx
  * Running PHP5 FPM application server rather than a PHP module for Apache or Nginx
  * Dropped incomplete support for Zend Framework
  * Dropped Gitosis as a default, since I imagine I'm the only person using it, and it's a bit out of place
  * Added Alerts for critical systems and failure/limp conditions
  * New MCI which includes RightLink 5.6.28 and creates an 8GB root partition rather than 10GB
  * Added ability to connect this server with the [Opscode](http://www.opscode.com/platform/) Chef platform to further customize your instance
* Rev 4
  * Updated to latest RightScale assets (RightLink 5.8, Storage Toolbox, etc)
  * Added a default vhost with phpmyadmin
* Rev 5
  * Changes to Chef repository to allow public access
* Rev 6
  * Better defaults for Nginx
  * Proper support for EBS Backed instances


# TODO #
* Setup a default vhost
  * Including an SSL vhost that hosts various tools like phpmyadmin and a management tool for email configuration etc.
    * This is partially done, in that phpmyadmin is deployed in a default vhost that redirects to SSL
* More alerts
  * Postfix high load
  * MySQL high load
  * Low memory
  * Nginx high load
* Reconsider ZendFramework support
* Enable gitweb (probably within aforementioned SSL vhost)
* Full and proper email stack (local delivery, pop3, imap, ldap configuration)</description>
    <name>Wordpress &amp; Email All-In-One</name>
    <created_at>2012/08/06 21:59:05 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>6</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes></revision_notes>
    <updated_at>2012/08/26 05:30:07 +0000</updated_at>
    <publisher>Ryan Geyer</publisher>
    <content_type>CookbookRepoSequence</content_type>
    <commit_message>
      <text>Fixed Postfix w/MySQL for CentOS</text>
      <time>2012/08/26 05:04:22 +0000</time>
      <user>ryan.geyer@rightscale.com</user>
    </commit_message>
    <description></description>
    <name>RightScale (v12.11.0-LTS) + LNMP</name>
    <created_at>2012/08/26 05:30:05 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>4</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
  <publication>
    <revision_notes>  * Install postfix mysql_pgsql from centosplus on CentOS
  * Update app_wordpress to require nginx, apache, and php5 so that recipes can be run as operational scripts
  * Set LVM vg data size to 50% to prevent possible data corruption
  * Remove scheduler cookbook/recipe, using block_device continuous backups instead
  * Set max snapshots to 10.  7 Daily + 1 Weekly + 1 Monthly + 1 Yearly = 10</revision_notes>
    <updated_at>2012/08/26 05:30:07 +0000</updated_at>
    <publisher>Ryan Geyer</publisher>
    <content_type>ServerTemplate</content_type>
    <commit_message>
      <text>  * Install posfix mysql_pgsql from centosplus on CentOS
  * Update app_wordpress to require nginx, apache, and php5 so that recipes can be run as operational scripts
  * Set LVM vg data size to 50% to prevent possible data corruption
  * Remove scheduler cookbook/recipe, using block_device continuous backups instead
  * Set max snapshots to 10.  7 Daily + 1 Weekly + 1 Monthly + 1 Yearly = 10</text>
      <time>2012/08/26 05:29:06 +0000</time>
      <user>ryan.geyer@rightscale.com</user>
    </commit_message>
    <description># Description #
This is an All-In-One (AIO) server for hosting PHP based web sites/applications, as well as email for one or many domain names (virtual hosting).

## Total Cost of Ownership ##
This ServerTemplate is designed to run within the confines of a [t1.micro](http://aws.amazon.com/ec2/instance-types/) EC2 instance.  A t1.micro instance requires that you use an EBS volume to store the operating system.  The MultiCloud Image this ServerTemplate uses automatically creates an 8GB EBS volume for this purpose.

This server template requires one additional EBS volume for storing configuration and application data, the size of which will vary based on what you're running.  The default size for this partition is 2GB.  Combined with the 8GB root partition the total EBS footprint is exactly 10GB, the maximum for the AWS free tier.

When you first sign up for AWS you can take advantage of their [free tier](http://aws.amazon.com/free/) for all services for one year.

While using this server template I've averaged $0.12 per month between EIP data transfer costs, and the additional EBS volume.

After one year when the free tier expires, you can expect to spend under $15 per month if you pay for a t1.micro reserved instance, broken down thusly.

* t1.micro reservation (heavy usage) for 1 year $62 ($5.17/mo but billed once at the beginning)
* 730hr t1.micro usage @$0.005/hr (Reserved cost in US-EAST cloud) $3.65/mo
* 8GB EBS Volume $0.80/mo
* 2GB EBS Volume $0.20/mo
* Snapshot Storage is variable depending on how you configure your retention policy.  Snapshots are incremental and store only the delta, so actual storage costs are quite low.

That totals out to $9.82/mo, which leaves $5.18 (out of $15) for data transfer, I/O requests and maybe some S3 storage.

As I personally run this more, I'll be able to give some more real world data, rather than just estimates.  The point though, is that this is dirt cheap given the control you have!

## LNMP Virtual Hosting ##
The web hosting environment is a full LNMP stack consisting of;

* Linux - CentOS 5.8
* Nginx - 1.2.2
* MySQL - 5.1.55-community
* PHP - 5.3.6

## Email Virtual Hosting ##
In addition to the LNMP stack, a Postfix server is installed and configured for virtual hosting of one or many email domains.  Currently, the postfix server is configured to relay email for configured email addresses (more information on that below) to one or more other email addresses.  I use this to accept email for a domain, and effectively "forward" it to my gmail account where I manage all of my email.

# Usage #

## Prerequisites ##

### Elastic IP ###
It is *HIGHLY* recommended that you setup an Elastic IP for your server instance if you run this on AWS.  This will make things like vertical scaling and disaster recovery easier.

In clouds besides AWS, or in absence of an Elastic IP you'll just have to make DNS changes and wait for those changes to propagate.

Also, if you're going to be serious about running an email server, using an EIP is the only way to go so you don't get blacklisted etc.  Setup an EIP, then make sure you fill out [this form](https://aws-portal.amazon.com/gp/aws/html-forms-controller/contactus/ec2-email-limit-rdns-request) to setup a reverse DNS record for your hostname (like mail.yourdomain.com) to your EIP.  You can read about why this is important [here](http://www.simpledns.com/kb.aspx?kbid=1052)

### Security Groups ###
You'll need to be able to communicate with your server from the interwebs.  This means you'll need to open some ports in one or more security groups, and add your server instance to those security groups.

In clouds which do not support security groups set the "Firewall" input to enabled, and all inbound access (besides the required ports listed below) will be blocked.

As a best practice, try to avoid making all of your changes to the "default" security group.  It's also better if you put the ports for each service in it's own security group, though just one security group which opens all ports for this server instance is probably okay too.  Here are the ports that are required to be able to communicate with this server.

* SSH - TCP:22
* SMTP - TCP:25
* HTTP - TCP:80
* HTTPS - TCP:443

## Launching for the first time ##
If you've just imported this ServerTemplate from the library, here's what you need to know to get started.

### Inputs ###
* Database Admin Password

  Pick a secure password for the database administrator.  The default administrator username is "administrator".  It's possible that you'll never need to use these credentials since the Chef recipes set everything up for you, but it's good to have in case of emergency or for administrative tasks not covered in an operational script etc.

* Postfix MySQL Database Password

  Pick a secure password for the user account that postfix will use to access the MySQL database.  Did I mention that Postfix configuration information is stored in MySQL?  I promise, I'll explain later.
* Total Volume Size (1)

  This server stores all of the data which needs to be persistent either on a separate attached storage volume, or on an LVM partition of your ephemeral storage to ease backups, disaster recovery, and vertical scaling.  Specify a volume size here that makes sense for the data you're storing, including MySQL databases and your web site/application html and code files.  **NOTE**: The default is 2GB

* Backup Lineage (1)

For the attached volume, and for the continuous backups a lineage needs to be specified.  This is effectively a name for the data backup, feel free to specify anything for this.  For all of the volume management stuff I'm making heavy use of the RightScale "Storage Toolbox", and this input comes from those tools.  Take a peek at the documentation and runbook for the "Storage Toolbox" [here](http://support.rightscale.com/12345-Tutorials/Storage_Toolbox/Storage_Toolbox_Runbook)

* Web Server Hostname

Some basic tools will get installed and hosted for this server on a particular hostname.  These are things like phpmyadmin, and (hopefully, eventually) some web UI tools for managing your server.  You can specify the hostname you want this to appear on.  I recommend that you use a hostname specific to the management of this server, like tools.domain.com etc.

If you're in a hurry, and just wanted to get this up and running quickly, that's all you'll need to know.

## Disaster Recovery or Vertical Scaling ##
As mentioned, all of the configuration and application data for all the services is stored on an attached or LVM managed volume.  That volume has a snapshot taken of it once per day.  Those snapshots can be used to start a new instance of this server with the data and configuration exactly as it was at that point in time.

This is useful for vertical scaling.  I.E. Using a bigger, badder instance type to manage more traffic.  It's also useful for disaster recovery.

To bring up a new instance from a snapshot, these are the steps.

1. Find the AWS ID of the latest snapshot for your data volume
  * Alternate first step is to create a snapshot "right now" by running the "block_device::do_primary_backup" or "block_device::do_secondary_backup" recipe on the current instance.
2. Add a new server to your deployment using this ServerTemplate
3. Click "Launch" and set all of your inputs to the desired values
4. Launch the new instance
5. Run the "nginx::setup_vhost" or "app_wordpress::deploy" (which ever is appropriate) once for each vhosted domain this server answers for.
6. Verify web and email vhosts are working properly (change /etc/hosts file to point to new IP etc)
7. Change your DNS records from the IP of the old instance, to the new one
  * **Pro Tip**: Or, if you're using an Elastic IP, just reassign the the EIP to the new instance
8. Once DNS records are propagated, or EIP remap is finished, decommission old instance
9. Clean up volume and snapshots of old instance
  * See "Managing Artifacts" below

# Configuring Services #

## Wordpress Powered Website ##
If you want to host a Wordpress powered website, you're only a few inputs and clicks away

Inputs
1. MySQL Database Password for this Wordpress instance
  Pick a secure password which Wordpress will use to access the database.  The Wordpress configuration file will automatically be created with this information
2. VHOST Aliases
  The possible hostname aliases (if any) for the vhost.  For instance to host the same content at www.yourdomain.com and yourdomain.com simply put "yourdomain.com" here.  Many values can be supplied, separated by spaces.  If you don't want any aliases leave the text missing in this field.
3. VHOST FQDN
  The fully qualified domain name (FQDN) of the new vhost to create.  Example www.apache.org

## Website ##
If you want to host a website that's just static HTML, or a mix of HTML and some PHP files, you can set it up by running the "nginx::setup_vhost" script.

This script takes only two inputs.
1. VHOST Aliases
  The possible hostname aliases (if any) for the vhost.  For instance to host the same content at www.yourdomain.com and yourdomain.com simply put "yourdomain.com" here.  Many values can be supplied, separated by spaces.  If you don't want any aliases leave the field empty.
2. VHOST FQDN
  The fully qualified domain name (FQDN) of the new vhost to create.  Example www.apache.org

Running the script will create the necessary configuration file(s) for Apache2.  The root directory for the new website will be /mnt/storage/www/&lt;VHOST FQDN&gt;/htdocs.  Put the your web files there and you're all set!

## Postfix Email Relaying ##
The configuration for postfix is stored in a MySQL database, thus the input attributes for a postfix MySQL user, database, and password.  Right now, you'll need to get right into the MySQL commandline in order to manipulate the configuration but there are plans to make this much more user friendly in the future.

### Virtual Domains ###
The first thing you'll need to do is tell postfix which domain names it'll be handling email for.

When connected to the server with SSH, type `mysql` to get into a mysql commandline client.  Then type `use postfix;` to select the postfix configuration database.  If you supplied a different database name for the postfix configuration, substitute that in the use command.  Then, for each domain you want to handle email for, run the following MySQL query.

_INSERT INTO transport (domain,destination) VALUES ('yourdomain.com','virtual:')_

Where 'yourdomain.com' is the domain name you want to handle email for.

### Virtual User Aliases ###
Once you've defined the domain names that you'll be handling email for, you'll want to setup which email addresses you'll be accepting email for, and what email address to relay them to.

When connected to the server with SSH, type `mysql` to get into a mysql commandline client.  Then type `use postfix;` to select the postfix configuration database.  If you supplied a different database name for the postfix configuration, substitute that in the use command.  Then, for each email address you want to accept email for, run the following MySQL query.

_INSERT INTO virtual (email,destination) VALUES ('you@yourdomain.com','you@gmail.com')_

The first value is the email address which your server will accept email for.  The 'yourdomain.com' must already be in transport table, which you would have added in the "Virtual Domains" section above.

The second value is the email address you want any emails sent to the 'you@yourdomain.com' relayed to.  It's just that easy!

You can specify many different email addresses to be relayed to the same destination address.  You can also specify a "catchall" destination for a domain by excluding the user.  I.E. Supplying '@yourdomain.com' for the first value, and 'you@gmail.com' as the second value would route any email sent to any address @yourdomain.com to your gmail address.  It's not advisable, but it can be done.

# Managing Artifacts #
We've mentioned a couple times above that this server uses attachable volumes (where available) to store configuration and application data.  The creation of that volume, and the creation of the snapshots for backups is fully automated.  The number of snapshots for the current instance is even kept in check by the backup policy inputs.

However, when you launch a new instance to replace an existing one, some artifacts get left behind which will need to be manually cleaned up.  Below you'll find information on what things to look out for.  Automating this cleanup is VERY high on my priority list for enhancements of this ServerTemplate.

## Volumes ##
When you terminate a running instance of this server template, the automatically created volume is not deleted.  So after performing the steps from the "Disaster Recovery or Vertical Scaling" section above, you'll want to look at the volumes in the same cloud as the terminated instance, and go ahead and delete it.

You may want to verify that you have a current snapshot of the volume first, though you would probably have already done that before launching a new instance and terminating the old one.

## Snapshots ##
Snapshots of the old volume associated with a terminated instance are not automatically deleted by the backup script based.  This is because the snapshots are not associated with the new volume or instance, so the script has no way of knowing that they are related.

As a result, you'll want to delete old snapshots which belong to terminated instances and/or deleted volumes.

# Change Log #
* Rev 1
  * Initial release
* Rev 2
  * Replaced Apache with Nginx
  * Running PHP5 FPM application server rather than a PHP module for Apache or Nginx
  * Dropped incomplete support for Zend Framework
  * Dropped Gitosis as a default, since I imagine I'm the only person using it, and it's a bit out of place
  * Added Alerts for critical systems and failure/limp conditions
  * New MCI which includes RightLink 5.6.28 and creates an 8GB root partition rather than 10GB
  * Added ability to connect this server with the [Opscode](http://www.opscode.com/platform/) Chef platform to further customize your instance
* Rev 4
  * Updated to latest RightScale assets (RightLink 5.8, Storage Toolbox, etc)
  * Added a default vhost with phpmyadmin
* Rev 5
  * Changes to Chef repository to allow public access
* Rev 6
  * Better defaults for Nginx
  * Proper support for EBS Backed instances
* Rev 7
  * Install posfix mysql_pgsql from centosplus on CentOS
  * Update app_wordpress to require nginx, apache, and php5 so that recipes can be run as operational scripts
  * Set LVM vg data size to 50% to prevent possible data corruption
  * Remove scheduler cookbook/recipe, using block_device continuous backups instead
  * Set max snapshots to 10.  7 Daily + 1 Weekly + 1 Monthly + 1 Yearly = 10


# TODO #
* Setup a default vhost
  * Including an SSL vhost that hosts various tools like phpmyadmin and a management tool for email configuration etc.
    * This is partially done, in that phpmyadmin is deployed in a default vhost that redirects to SSL
* More alerts
  * Postfix high load
  * MySQL high load
  * Low memory
  * Nginx high load
* Reconsider ZendFramework support
* Enable gitweb (probably within aforementioned SSL vhost)
* Full and proper email stack (local delivery, pop3, imap, ldap configuration)</description>
    <name>Wordpress &amp; Email All-In-One</name>
    <created_at>2012/08/26 05:30:06 +0000</created_at>
    <links>
      <link href="/api/publications/12345" rel="self"/>
      <link href="/api/publication_lineages/12345" rel="lineage"/>
    </links>
    <revision>7</revision>
    <actions>
      <action rel="import"/>
    </actions>
  </publication>
</publications>
